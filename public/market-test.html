<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market - Global Assets</title>
    <link rel="stylesheet" href="./css/homepage.css">
    <link rel="stylesheet" href="./css/market.css">
    <link rel="icon" type="image/x-icon" href="./Images/favicon.ico">
</head>
<body>

<header id="header">
    <div class="header-container">
        <div class="nav-menu">
            <div class="logo-container">
               <a href="./"> <img src="./Images/home_logo.png" alt="Company Logo"> </a>
            </div>
            <nav class="desktop-nav">
                <a href="./" class="nav-item">Home</a>
                <a href="./market.html" class="nav-item">Market</a>
                <a href="./ai-finance.html" class="nav-item">AI Finance</a>
                <a href="./loan.html" class="nav-item">Loans</a>
                <a href="./profile.html" class="nav-item">Account</a>
            </nav>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn sign-up-btn">Sign Up</button>
            <button id="nav-black-btn" class="nav-btn sign-in-btn">Sign In</button>
        </div>

        <button class="mobile-menu-toggle">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
         <a href="./" class="nav-item">Home</a>
         <a href="./market.html" class="nav-item">Market</a>
         <a href="./ai-finance.html" class="nav-item">AI Finance</a>
         <a href="./loan.html" class="nav-item">Loans</a>
         <a href="./profile.html" class="nav-item">Account</a>
        <div class="nav-buttons">
            <button class="nav-btn sign-up-btn">  Sign Up</button>
            <button id="nav-black-btn" class="nav-btn sign-in-btn">Sign In</button>
        </div>
    </nav>
  </header>

    <main class="market-container">
        <!-- Filter Section -->
        <div class="asset-filters">
            <button class="filter-btn">Favorites</button>
            <button class="filter-btn">Forex</button>
            <button class="filter-btn active">Digital Assets</button>
            <button class="filter-btn">Stock</button>
            <button class="filter-btn">ETF</button>
        </div>

        <!-- Top Assets Grid -->
<div class="top-assets-grid">
    <!-- BTC Card -->
    <article class="asset-card">
        <div class="asset-header">
            <img src="./Images/btc-icon.svg" alt="BTC" class="asset-icon">
            <div>
                <div class="asset-name">BTC/USDT</div>
                <div class="asset-price">$95,232.99</div>
            </div>
        </div>
        <div class="asset-info">
            <div class="asset-change negative">▼ 1.05%</div>
            <div class="card-chart-container">
                <canvas class="mkt-sparkline" 
                        data-values="95.5,96,95,96.5,97,96,95,94.5,95,94"
                        data-positive="false"></canvas>
            </div>
        </div>
    </article>

    <!-- ETH Card -->
    <article class="asset-card">
        <div class="asset-header">
            <img src="./Images/eth-icon.svg" alt="ETH" class="asset-icon">
            <div>
                <div class="asset-name">ETH/USDT</div>
                <div class="asset-price">$1,824.74</div>
            </div>
        </div>
        <div class="asset-info">
            <div class="asset-change negative">▼ 0.71%</div>
            <div class="card-chart-container">
                <canvas class="mkt-sparkline"
                        data-values="1820,1815,1824,1828,1830,1825,1820,1818,1820,1824"
                        data-positive="false"></canvas>
            </div>
        </div>
    </article>

    <!-- XRP Card -->
    <article class="asset-card">
        <div class="asset-header">
            <img src="./Images/xrp-icon.svg" alt="XRP" class="asset-icon">
            <div>
                <div class="asset-name">XRP/USDT</div>
                <div class="asset-price">$2.1702</div>
            </div>
        </div>
        <div class="asset-info">
            <div class="asset-change positive">▲ 0.50%</div>
            <div class="card-chart-container">
                <canvas class="mkt-sparkline"
                        data-values="2.15,2.16,2.17,2.18,2.17,2.165,2.16,2.155,2.16,2.17"
                        data-positive="true"></canvas>
            </div>
        </div>
    </article>
</div>

        <!-- Market Table -->
        <div class="market-table">
            <div class="table-header">
                <div>Name</div>
                <div>24h %</div>
                <div>Chart</div>
                <div>Price</div>
            </div>

            <!-- Table Rows -->
            <div class="table-row">
                <div class="asset-name-cell">
                    <img src="./Images/btc-icon.svg" alt="BTC" class="asset-icon">
                    <span>BTC/USDT</span>
                </div>
                <div class="negative">▼ 1.05%</div>
                <div class="chart-container">
                    <canvas class="mkt-sparkline" 
                            data-values="95.5,96,95,96.5,97,96,95,94.5,95,94"
                            data-positive="false"></canvas>
                </div>
                <div>$95,232.99</div>
            </div>

            <div class="table-row">
                <div class="asset-name-cell">
                    <img src="./Images/eth-icon.svg" alt="ETH" class="asset-icon">
                    <span>ETH/USDT</span>
                </div>
                <div class="negative">▼ 0.71%</div>
                <div class="chart-container">
                    <canvas class="mkt-sparkline"
                            data-values="1820,1815,1824,1828,1830,1825,1820,1818,1820,1824"
                            data-positive="false"></canvas>
                </div>
                <div>$1,824.74</div>
            </div>

            <div class="table-row">
                <div class="asset-name-cell">
                    <img src="./Images/xrp-icon.svg" alt="XRP" class="asset-icon">
                    <span>XRP/USDT</span>
                </div>
                <div class="positive">▲ 0.50%</div>
                <div class="chart-container">
                    <canvas class="mkt-sparkline"
                            data-values="2.15,2.16,2.17,2.18,2.17,2.165,2.16,2.155,2.16,2.17"
                            data-positive="true"></canvas>
                </div>
                <div>$2.1702</div>
            </div>

            <div class="table-row">
                <div class="asset-name-cell">
                    <img src="./Images/trx-icon.svg" alt="TRX" class="asset-icon">
                    <span>TRX/USDT</span>
                </div>
                <div class="positive">▲ 0.32%</div>
                <div class="chart-container">
                    <canvas class="mkt-sparkline"
                            data-values="0.24,0.245,0.246,0.247,0.248,0.247,0.246,0.245,0.246,0.2465"
                            data-positive="true"></canvas>
                </div>
                <div>$0.2465</div>
            </div>
        </div>

        <!-- Pagination -->
        <div class="pagination">
            <button class="page-btn">← Previous</button>
            <button class="page-btn active">1</button>
            <button class="page-btn">2</button>
            <button class="page-btn">3</button>
            <button class="page-btn">4</button>
            <button class="page-btn">Next →</button>
        </div>
    </main>

    <!-- footer -->

     <footer class="footer">
    <div class="footer-content">
      <!-- Logo / Brand -->
      <div class="footer-section logo-section">
        <img src="./Images/logo_foot.png" alt="Global Assets Logo" class="footer-logo">
      </div>
      <!-- Company -->
      <div class="footer-section">
        <h4>Company</h4>
        <ul>
          <li><a href="./about.html">About Us</a></li>
          <li><a href="./team.html">About the Team</a></li>
          <li><a href="./faq.html">Help Center</a></li>
          <li><a href="#">Email support</a></li>
          <li><a href="mailto:service@global-assets.com">service@global‑assets.io</a></li>
        </ul>
      </div>
      <!-- Product -->
      <div class="footer-section">
        <h4>Product</h4>
        <ul>
          <li><a href="./market.html">Market List</a></li>
          <li><a href="./loan.html">Investment loans</a></li>
          <li><a href="./ai-finance.html">AI Finance</a></li>
        </ul>
      </div>
      <!-- Policy -->
      <div class="footer-section">
        <h4>Policy</h4>
        <ul>
          <li><a href="./agrt.html">User Services Agreement</a></li>
          <li><a href="./loan-agrt.html">Loan agreement</a></li>
          <li><a href="./loan-explain.html">Loan rules explanation</a></li>
          <li><a href="./legal-liability.html">Legal liability</a></li>
        </ul>
      </div>
      <!-- Statement -->
      <div class="footer-section">
        <h4>Statement</h4>
        <ul>
          <li><a href="./risk.html">Risk Warning</a></li>
          <li><a href="./privacy-statement.html">Privacy Statement</a></li>
          <li><a href="./anti-laundaring.html">Anti‑Money Laundering Policy</a></li>
          <li><a href="./rglt-licence.html">Regulatory license</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      &copy; Copyright 2016 – 2025 Global Assets. All rights reserved.
    </div>
  </footer>
    
    
    
    <script src="./javascript/common-script.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
  
          // --- Configuration ---
          // The backend API endpoint for fetching paginated crypto assets
          const apiUrl = '/api/v1/market/get-asset-data';
          const limit = 10; // Number of assets to display per page
          let currentPage = 1; // Start on the first page
  
          // --- DOM Elements ---
          const topAssetsGrid = document.querySelector('.top-assets-grid');
          const marketTableBody = document.querySelector('.market-table'); // Select the table container
          const paginationContainer = document.querySelector('.pagination');
  
          // --- Sparkline Drawing ---
          function drawSparkline(canvas) {
              const ctx = canvas.getContext('2d');
              const valuesString = canvas.dataset.values;
              const positive = canvas.dataset.positive === 'true';
  
              if (!valuesString) {
                  ctx.clearRect(0, 0, canvas.width, canvas.height);
                  return; // Nothing to draw
              }
  
              const values = valuesString.split(',').map(Number);
  
              canvas.width = canvas.clientWidth;
              canvas.height = canvas.clientHeight;
  
              const w = canvas.width;
              const h = canvas.height;
  
              if (values.length < 2) {
                   ctx.clearRect(0, 0, canvas.width, canvas.height);
                   if (values.length === 1) {
                       // Optional: draw a dot for single point
                       ctx.fillStyle = positive ? '#10b981' : '#ef4444';
                       ctx.beginPath();
                       ctx.arc(w / 2, h / 2, 2, 0, Math.PI * 2); // Draw a dot in the middle
                       ctx.fill();
                   }
                   return;
              }
  
              const max = Math.max(...values);
              const min = Math.min(...values);
  
  
              ctx.beginPath();
              values.forEach((v, i) => {
                  const x = (values.length === 1) ? w / 2 : (i / (values.length - 1)) * w;
                  // Prevent division by zero if max === min
                  const y = (max === min) ? h / 2 : h - ((v - min) / (max - min)) * h;
  
                  if (i === 0) {
                      ctx.moveTo(x, y);
                  } else {
                      ctx.lineTo(x, y);
                  }
              });
  
              ctx.strokeStyle = positive ? '#10b981' : '#ef4444';
              ctx.lineWidth = 1.5;
              ctx.stroke();
          }
  
          function drawAllSparklines() {
              document.querySelectorAll('.mkt-sparkline').forEach(drawSparkline);
          }
  
          // --- Rendering Functions ---
  
          // Render the top 3 asset cards
          function renderTopAssets(assets) {
              const top3 = assets.slice(0, 3); // Take the first 3 assets from the current page
              topAssetsGrid.innerHTML = ''; // Clear previous cards
  
              top3.forEach(a => {
                   // Defensive check for critical properties before using them
                  const symbol = a.symbol || 'N/A';
                  const logo = a.logo || ''; // Use empty string for broken image
                  const price = typeof a.price === 'number' ? a.price : 0; // Default price to 0 if not number
                  const percentChange = typeof a.percent_change_24h === 'number' ? a.percent_change_24h : 0; // Default to 0
                  const sparklineData = Array.isArray(a.sparkline) ? a.sparkline : []; // Default to empty array
                   const cmcId = a.id; // Assuming id is always present
  
  
                  const card = document.createElement('article');
                  card.className = 'asset-card';
                  card.dataset.cmcId = cmcId; // Add ID for click handler
                  card.innerHTML = `
                      <div class="asset-header">
                          <img src="${logo}" alt="${symbol}" class="asset-icon">
                          <div>
                              <div class="asset-name">${symbol}/USD${(symbol === 'USDT' || symbol === 'USDC') ? '' : 'T'}</div>
                              <div class="asset-price">$${price.toFixed(price > 100 ? 2 : 4)}</div>
                          </div>
                      </div>
                      <div class="asset-info">
                          <div class="asset-change ${percentChange >= 0 ? 'positive' : 'negative'}">
                              ${percentChange >= 0 ? '▲' : '▼'} ${Math.abs(percentChange).toFixed(2)}%
                          </div>
                          <div class="card-chart-container">
                              <canvas class="mkt-sparkline"
                                      data-values="${sparklineData.join(',')}"
                                      data-positive="${percentChange >= 0}"></canvas>
                          </div>
                      </div>`;
                  topAssetsGrid.appendChild(card);
              });
              // drawAllSparklines will be called after both render functions
              // addAssetClickListeners will be called after both render functions
          }
  
          // Render the full market table rows
          function renderTableRows(assets) {
              // Keep the header row if it exists, remove all other rows
              marketTableBody.querySelectorAll('.table-row').forEach(r => r.remove());
  
              assets.forEach(a => {
                   // Defensive check for critical properties before using them
                   const symbol = a.symbol || 'N/A';
                   const logo = a.logo || ''; // Use empty string for broken image
                   const price = typeof a.price === 'number' ? a.price : 0; // Default price to 0 if not number
                   const percentChange = typeof a.percent_change_24h === 'number' ? a.percent_change_24h : 0; // Default to 0
                   const sparklineData = Array.isArray(a.sparkline) ? a.sparkline : []; // Default to empty array
                   const cmcId = a.id; // Assuming id is always present
  
                  const row = document.createElement('div');
                  row.className = 'table-row';
                  row.dataset.cmcId = cmcId; // Add ID for click handler
                  row.style.cursor = 'pointer'; // Indicate it's clickable
  
                  row.innerHTML = `
                      <div class="asset-name-cell">
                          <img src="${logo}" alt="${symbol}" class="asset-icon">
                          <span>${symbol}/USD${(symbol === 'USDT' || symbol === 'USDC') ? '' : 'T'}</span>
                      </div>
                      <div class="${percentChange >= 0 ? 'positive' : 'negative'}">
                          ${percentChange >= 0 ? '▲' : '▼'} ${Math.abs(percentChange).toFixed(2)}%
                      </div>
                      <div class="chart-container">
                          <canvas class="mkt-sparkline"
                                  data-values="${sparklineData.join(',')}"
                                  data-positive="${percentChange >= 0}"></canvas>
                      </div>
                      <div>$${price.toFixed(price > 100 ? 2 : 4)}</div>`;
                  marketTableBody.appendChild(row);
              });
               // drawAllSparklines will be called after both render functions
               // addAssetClickListeners will be called after both render functions
          }
  
          // Render the pagination controls
          function renderPagination(totalCount) {
              paginationContainer.innerHTML = ''; // Clear previous pagination
  
              const totalPages = Math.max(1, Math.ceil(totalCount / limit));
  
              if (totalPages === 1) {
                  const btn = document.createElement('button');
                  btn.className = 'page-btn active';
                  btn.textContent = '1';
                  btn.disabled = true;
                  paginationContainer.appendChild(btn);
                  return;
              }
  
              // Previous button
              const prev = document.createElement('button');
              prev.className = 'page-btn';
              prev.textContent = '← Previous';
              prev.disabled = currentPage === 1;
              prev.addEventListener('click', () => {
                  if (currentPage > 1) {
                      currentPage--;
                      fetchData();
                  }
              });
              paginationContainer.appendChild(prev);
  
              const maxVisible = 3; // Show 3 pages at a time
              let start = currentPage;
              let end = Math.min(currentPage + maxVisible - 1, totalPages);
  
              // Adjust start if near the end
              if (end - start < maxVisible - 1) {
                  start = Math.max(1, end - maxVisible + 1);
              }
  
              // Show current range of pages
              for (let i = start; i <= end; i++) {
                  const btn = document.createElement('button');
                  btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
                  btn.textContent = i;
                  btn.disabled = i === currentPage; // Disable the current page button
                  btn.addEventListener('click', () => {
                      currentPage = i;
                      fetchData();
                  });
                  paginationContainer.appendChild(btn);
              }
  
              // Show ellipsis if there are more pages after current range
              if (end < totalPages) {
                  const dots = document.createElement('span');
                  dots.className = 'page-dots';
                  dots.textContent = '...';
                  paginationContainer.appendChild(dots);
  
                  const last = document.createElement('button');
                  last.className = 'page-btn';
                  last.textContent = totalPages;
                  last.addEventListener('click', () => {
                      currentPage = totalPages;
                      fetchData();
                  });
                  paginationContainer.appendChild(last);
              }
  
              // Next button
              const next = document.createElement('button');
              next.className = 'page-btn';
              next.textContent = 'Next →';
              next.disabled = currentPage === totalPages;
              next.addEventListener('click', () => {
                  if (currentPage < totalPages) {
                      currentPage++;
                      fetchData();
                  }
              });
              paginationContainer.appendChild(next);
          }
  
  
          // --- Data Fetching Function ---
          function fetchData() {
              // Calculate the 'start' parameter for the backend API (1-based)
              const start = (currentPage - 1) * limit + 1;
  
              fetch(`${apiUrl}?limit=${limit}&start=${start}`)
                  .then(response => {
                      if (!response.ok) {
                           // Only log HTTP errors, don't throw just yet
                          return response.json().then(err => {
                               console.error(`HTTP error! Status: ${response.status}`, err);
                               throw new Error(err.message || `HTTP error! status: ${response.status}`);
                          });
                      }
                      return response.json();
                  })
                  .then(jsonResponse => {
                      if (!jsonResponse.success) {
                           // Only log backend reported errors, don't throw just yet
                           console.error('Backend API reported an error:', jsonResponse.message);
                           throw new Error(jsonResponse.message || 'Backend API call unsuccessful');
                      }
  
                      const { assets, totalCount } = jsonResponse.data;
  
                      // Render the data on the page
                      renderTopAssets(assets); // Render top 3 from the fetched page
                      renderTableRows(assets); // Render all assets from the fetched page
  
                      // Call drawAllSparklines and add click listeners *after* both rendering functions
                      drawAllSparklines();
                      addAssetClickListeners(topAssetsGrid.querySelectorAll('.asset-card'));
                      addAssetClickListeners(marketTableBody.querySelectorAll('.table-row'));
  
                      renderPagination(totalCount); // Render pagination based on total assets
  
                  })
                  .catch(error => {
                      // This catch block handles fetch errors, non-ok HTTP responses,
                      // backend success: false responses, and any errors during
                      // the rendering functions or promise chain
                      console.error('Fetch or processing error:', error);
  
  
                      // Display error messages on the UI
                      if (topAssetsGrid) {
                          topAssetsGrid.innerHTML = '<p style="text-align: center; color: red;">Error loading top assets.</p>';
                      }
                      if (marketTableBody) {
                          // Clear previous rows but keep header
                          marketTableBody.querySelectorAll('.table-row').forEach(r => r.remove());
                          const errorRow = document.createElement('div');
                          errorRow.className = 'table-row'; // Use table-row for styling if needed
                           // Use grid-column span to center message across table columns
                          errorRow.innerHTML = '<div style="grid-column: span 4; text-align: center; color: red; padding: 20px;">Error loading data. Please try again later.</div>';
                          marketTableBody.appendChild(errorRow);
                      }
                      if (paginationContainer) {
                          paginationContainer.innerHTML = ''; // Clear pagination on error
                      }
                  });
          }
  
          // --- Asset Click Listener ---
          // Function to add click listeners to elements representing assets
          function addAssetClickListeners(elements) {
              elements.forEach(element => {
                  // Get the asset ID from the data attribute
                  const cmcId = element.dataset.cmcId;
  
                  if (cmcId) {
                      element.addEventListener('click', () => {
                          // console.log(`Asset clicked! Navigating to history for ID: ${cmcId}`); // Removed log
                          // Navigate to the detailed history page, passing the asset ID
                          // You'll need to create /asset-details.html and its script
                          window.location.href = `/asset-details.html?id=${cmcId}`;
                      });
                  }
              });
          }
  
  
          // --- Initial Load & Event Listeners ---
  
          // Initial data fetch when the DOM is fully loaded for the default 'Digital Assets' view
          fetchData();
  
          // Re-draw sparklines on window resize (as you had)
          window.addEventListener('resize', drawAllSparklines);
  
          // --- Filter Button Logic (Placeholder) ---
          // (Your existing commented-out filter logic remains here)
  
  
      }); // End DOMContentLoaded
  </script>
    
        
</body>
</html>