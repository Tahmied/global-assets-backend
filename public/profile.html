<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | Global Assets</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/profile.css">
    <link rel="stylesheet" href="./css/homepage.css">
    <link rel="stylesheet" href="./css/chat.css">
    <link rel="icon" type="image/x-icon" href="./Images/favicon.ico">
</head>
<body>


<header id="header">
    <div class="header-container">
        <div class="nav-menu">
            <div class="logo-container">
               <a href="./"> <img src="./Images/home_logo.png" alt="Company Logo"> </a>
            </div>
            <nav class="desktop-nav">
                <a href="./" class="nav-item">Home</a>
                <a href="./market.html" class="nav-item">Market</a>
                <a href="./ai-finance.html" class="nav-item">AI Finance</a>
                <a href="./loan.html" class="nav-item">Loans</a>
                <a href="./profile.html" class="nav-item">Account</a>
            </nav>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn sign-up-btn">Sign Up</button>
            <button id="nav-black-btn" class="nav-btn sign-in-btn">Sign In</button>
        </div>

        <button class="mobile-menu-toggle">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
         <a href="./" class="nav-item">Home</a>
         <a href="./market.html" class="nav-item">Market</a>
         <a href="./ai-finance.html" class="nav-item">AI Finance</a>
         <a href="./loan.html" class="nav-item">Loans</a>
         <a href="./profile.html" class="nav-item">Account</a>
        <div class="nav-buttons">
            <button class="nav-btn sign-up-btn">  Sign Up</button>
            <button id="nav-black-btn" class="nav-btn sign-in-btn">Sign In</button>
        </div>
    </nav>
  </header>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu" style="display: none; position: absolute;">
      <div id="kyc-verification" class="menu-item">
        <i class="fas fa-shield-alt"></i>
        KYC Verification
      </div>
      <!-- <div class="menu-item">
        <i class="fas fa-history"></i>
        Transaction History
      </div> -->
      <!-- <div class="menu-item">
        <i class="fas fa-lock"></i>
        Change Password
      </div> -->
      <div class="menu-item" id="setTrxPassword">
        <i class="fas fa-key"></i>
        Set Transaction Password
      </div>
      <!-- <div class="menu-item">
        <i class="fas fa-cog"></i>
        Settings
      </div> -->
    </div>
  
    <!-- Profile Container -->
<div class="profile-container">
      <!-- Sidebar -->
      <aside class="profile-sidebar">
        <div class="profile-info">
          <img src="profile-pic.jpg" class="profile-pic" alt="Profile Picture">
          <h2>Loading..</h2>
          <div class="user-id">ID: Loading..</div>
          <div class="vip-status">
            <div class="vip-badge">
              <i class="fas fa-crown"></i>
              VIP <span id="vip-level">0</span>
            </div>
            <div class="vip-progress">
              <div class="progress-bar" style="width: 5%"></div>
            </div>
            <div class="vip-next">Next: VIP 1</div>
          </div>
          <div class="balance-card">
            <div class="balance-label">Account Balance</div>
            <div class="balance-amount">Loading...</div>
          </div>
          <div class="balance-card">
            <div class="balance-label">Loan Balance</div>
            <div class="balance-amount">Loading..</div>
          </div>
          <div class="balance-card">
            <div class="balance-label">Credit Score</div>
            <div class="balance-amount" id="credit-score">Loading..</div>
          </div>
          <div class="action-buttons">
            <button class="action-btn" id="depositBtn">
              <i class="fas fa-arrow-down"></i>
              Deposit
            </button>
            <button class="action-btn" id="withdrawBtn">
              <i class="fas fa-arrow-up"></i>
              Withdraw
            </button>
          </div>
        </div>
      </aside>
  
      <!-- Main Content -->
    <main class="profile-main">
        <div class="profile-main-header">
          <h2>Quick Actions</h2>
          <div class="header-icons">
            <a href="./notification.html">
              <button class="icon-btn">
              <i class="fas fa-bell"></i>
              <span class="notification-badge">0</span>
            </button>
          </a>
            
            <button class="icon-btn" id="mainMenuBtn">
              <i class="fas fa-ellipsis-v"></i>
            </button>
          </div>
        </div>
  
        <div class="quick-actions">
          <div id="kyc" class="action-card">
            <i class="fas fa-shield-alt action-icon"></i>
            <h3>KYC Verification</h3>
            <p>Complete your identity verification</p>
          </div>
          <div id="loan-history" class="action-card">
            <i class="fas fa-exchange-alt action-icon"></i>
            <h3>Loans</h3>
            <p>View your loans, repay them or check them.</p>
          </div>
          <div id="update-profile-div" class="action-card">
            <i class="fas fa-lock action-icon"></i>
            <h3>Update Profile</h3>
            <p>Change names &amp; security settings</p>
          </div>

          <div id="trx-record" class="action-card">
            <i style="font-size: 2rem;" class="fas fa-file-invoice-dollar"></i>
            <h3>Transaction Records</h3>
            <p>View All Your Transactions</p>
          </div>
        </div>
  
        <h2 style="margin-top: 3rem;">Contracts</h2>

        <div class="tabs-container">
          <div class="tabs-header">
            <button class="tab-btn active" data-tab-target="contracts">Contracts</button>
            <button class="tab-btn" data-tab-target="options">Options</button>
          </div>
        
          <!-- Contracts Tab -->
          <div class="tab-content active" id="contracts">
            <div class="transaction-cards">
             
            </div>
          </div>
        
          <!-- Options Tab -->
          <div class="tab-content" id="options">
            <div class="transaction-cards">
         
            </div>
          </div>
        </div> 

    </main>
</div>
  
    <!-- Transaction Password Modal -->
    <div class="modal-overlay" id="transactionPassModal" style="display: none; position: fixed; inset: 0; align-items: center; justify-content: center;">
      <div class="modal">
        <h2>Create Transaction Password</h2>
        <form id="transactionForm">
          <div style="margin: 1.5rem 0;">
            <input
              type="password"
              id="trxPassword"
              placeholder="Enter new transaction password"
              class="modal-input"
              required
            >
          </div>
          <button type="submit" class="modal-submit-btn">Set Password</button>
        </form>
      </div>
    </div>
  
    <!-- Notifications -->
    <div class="notification-container" id="notification"></div>

   <footer class="footer">
    <div class="footer-content">
      <!-- Logo / Brand -->
      <div class="footer-section logo-section">
        <img src="./Images/logo_foot.png" alt="Global Assets Logo" class="footer-logo">
      </div>
      <!-- Company -->
      <div class="footer-section">
        <h4>Company</h4>
        <ul>
          <li><a href="./about.html">About Us</a></li>
          <li><a href="./team.html">About the Team</a></li>
          <li><a href="./faq.html">Help Center</a></li>
          <li><a href="#">Email support</a></li>
          <li><a href="mailto:service@global-assets.com">service@global‑assets.io</a></li>
        </ul>
      </div>
      <!-- Product -->
      <div class="footer-section">
        <h4>Product</h4>
        <ul>
          <li><a href="./market.html">Market List</a></li>
          <li><a href="./loan.html">Investment loans</a></li>
          <li><a href="./ai-finance.html">AI Finance</a></li>
        </ul>
      </div>
      <!-- Policy -->
      <div class="footer-section">
        <h4>Policy</h4>
        <ul>
          <li><a href="./agrt.html">User Services Agreement</a></li>
          <li><a href="./loan-agrt.html">Loan agreement</a></li>
          <li><a href="./loan-explain.html">Loan rules explanation</a></li>
          <li><a href="./legal-liability.html">Legal liability</a></li>
        </ul>
      </div>
      <!-- Statement -->
      <div class="footer-section">
        <h4>Statement</h4>
        <ul>
          <li><a href="./risk.html">Risk Warning</a></li>
          <li><a href="./privacy-statement.html">Privacy Statement</a></li>
          <li><a href="./anti-laundaring.html">Anti‑Money Laundering Policy</a></li>
          <li><a href="./rglt-licence.html">Regulatory license</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      &copy; Copyright 2016 – 2025 Global Assets. All rights reserved.
    </div>
  </footer>

<!-- Chat Widget -->
<div class="chat-button" id="chatButton">
    <ion-icon name="chatbubbles"></ion-icon>
    <div class="unread-badge" id="unreadBadge">0</div>
</div>

<div class="chat-modal" id="chatModal">
    <div class="chat-header">
        <div class="chat-title">
            <h2>Chat with Support</h2>
            <div class="admin-status">
                <span class="status-dot" id="adminStatusDot"></span>
                <span id="adminStatusText">Connecting...</span>
            </div>
        </div>
        <button class="close-btn" id="closeChat">
            <ion-icon name="close"></ion-icon>
        </button>
    </div>
    
    <div class="chat-history" id="chatHistory">
        <div class="loading-message">Loading chat history...</div>
    </div>
    
    <div class="message-input-area">
        <textarea class="message-input" id="messageInput" placeholder="Type your message..." rows="1"></textarea>
        <button class="send-btn" id="sendMessage" disabled>
            <ion-icon name="send"></ion-icon>
        </button>
    </div>
</div>

<script nomodule src="https://cdnjs.cloudflare.com/ajax/libs/ionicons/7.1.0/ionicons/ionicons.js"></script>
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script src="./javascript/common-script.js"></script>
<script src="./javascript/loing-check.js"></script>
<script>
// Configuration
const CONFIG = {
    // Chat System Configuration
    API_BASE: `https://${window.location.hostname}/api/v1/chats`,
    WS_URL: `wss://${window.location.hostname}/ws/chat`,
    PRIMARY_CHAT_ADMIN_ID: "68083fb5d70405e5870c6594",
    RECONNECT_DELAY: 5000,
    MAX_RECONNECT_ATTEMPTS: 5,
    
    // API Endpoints
    ENDPOINTS: {
        PROFILE: '/api/v1/users/profile',
        SET_TRX_PASSWORD: '/api/v1/users/set-transaction-pass',
        COMPLETED_CONTRACTS: '/api/v1/market/contracts/getCompletedContractTrades',
        OPTION_TRADES: '/api/v1/market/options/trades',
        MARK_READ: '/api/v1/chats/chat/mark-read',
        SEND_MESSAGE: '/api/v1/chats/chat/send'
    },
    
    // UI Constants
    VIP_MAX_LEVEL: 9,
    NOTIFICATION_TIMEOUT: 4500,
    ERROR_DISPLAY_TIMEOUT: 5000
};

/**
 * Utility Functions
 */
const Utils = {
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    },

    getAuthToken() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            console.warn('[Auth] No access token found');
        }
        return token;
    },

    formatCurrency(amount) {
        return `$${Number(amount).toLocaleString()}`;
    },

    formatDate(date) {
        return new Date(date).toLocaleString();
    },

    extractAssetSymbol(assetPair) {
        return assetPair.split(/[/:]/)[0];
    },

    calculatePnlClass(value) {
        return value >= 0 ? 'positive' : 'negative';
    },

    formatPnlSign(value) {
        return value >= 0 ? '+' : '';
    }
};

/**
 * Notification System
 */
class NotificationSystem {
    constructor() {
        this.container = document.getElementById('notification');
    }

    show(message, type = 'success') {
        if (!this.container) return;

        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${Utils.escapeHtml(message)}</span>
            </div>
            <div class="notification-progress"></div>
        `;

        this.container.appendChild(notification);

        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 300);
        }, CONFIG.NOTIFICATION_TIMEOUT);
    }

    error(message) {
        this.show(message, 'error');
    }

    success(message) {
        this.show(message, 'success');
    }
}

/**
 * Profile Manager
 */
class ProfileManager {
    constructor(notificationSystem) {
        this.notifications = notificationSystem;
    }

    async fetchAndUpdate() {
        try {
            const response = await fetch(CONFIG.ENDPOINTS.PROFILE, {
                method: 'GET',
                credentials: 'include'
            });

            if (response.status === 401) {
                window.location.href = '/login.html';
                return;
            }

            if (!response.ok) {
                throw new Error('Profile data fetch failed');
            }

            const { data } = await response.json();
            this.updateProfileUI(data);
            this.checkLockStatus(data);

        } catch (error) {
            console.error('[Profile] Fetch error:', error);
            this.notifications.error('Failed to load profile data');
        }
    }

    updateProfileUI(user) {
        // Update basic info
        const nameElement = document.querySelector('.profile-info h2');
        if (nameElement) {
            nameElement.textContent = `${user.firstName} ${user.lastName}`;
        }

        const userIdElement = document.querySelector('.user-id');
        if (userIdElement) {
            const shortId = user._id.slice(-8);
            userIdElement.textContent = `ID: ${shortId}`;
        }

        // Update VIP status
        this.updateVipStatus(user.vipStatus);

        // Update profile picture
        if (user.dpLocalPath) {
            const profilePic = document.querySelector('.profile-pic');
            if (profilePic) {
                const path = user.dpLocalPath.replace(/^public[\\/]/, '').replace(/\\/g, '/');
                profilePic.src = `/${path}`;
            }
        }

        // Update balances
        const balanceElements = document.querySelectorAll('.balance-amount');
        if (balanceElements[0]) balanceElements[0].textContent = Utils.formatCurrency(user.accountBalance);
        if (balanceElements[1]) balanceElements[1].textContent = Utils.formatCurrency(user.loanBalance);

        // Update credit score
        const creditScoreElement = document.getElementById('credit-score');
        if (creditScoreElement) {
            creditScoreElement.textContent = user.creditScore;
        }

        // Update notification badge
        this.updateNotificationBadge(user.notification || []);
    }

    updateVipStatus(vipStatusStr) {
        const vipStatusString = vipStatusStr || 'vip 0';
        const levelMatch = vipStatusString.match(/vip\s*(\d+)/i);
        const vipLevel = levelMatch ? parseInt(levelMatch[1], 10) : 0;
        const nextLevel = vipLevel < CONFIG.VIP_MAX_LEVEL ? vipLevel + 1 : null;

        // Update VIP level display
        const vipLevelElement = document.getElementById('vip-level');
        if (vipLevelElement) {
            vipLevelElement.textContent = vipLevel;
        }

        // Update progress bar
        const progressBar = document.querySelector('.vip-progress .progress-bar');
        if (progressBar) {
            const percentage = Math.round((vipLevel / CONFIG.VIP_MAX_LEVEL) * 100);
            progressBar.style.width = `${percentage}%`;
        }

        // Update next level text
        const nextElement = document.querySelector('.vip-next');
        if (nextElement) {
            nextElement.textContent = nextLevel !== null ? `Next: VIP ${nextLevel}` : 'Max VIP';
        }
    }

    updateNotificationBadge(notifications) {
        const badge = document.querySelector('.notification-badge');
        if (badge) {
            const unreadCount = notifications.filter(notification => !notification.isRead).length;
            badge.textContent = unreadCount;
            badge.style.display = unreadCount > 0 ? 'flex' : 'none';
        }
    }

    checkLockStatus(userData) {
        if (!userData.isLocked) return;

        this.showLockModal();
    }

    showLockModal() {
        // Create blur overlay
        const blurOverlay = document.createElement('div');
        Object.assign(blurOverlay.style, {
            position: 'fixed',
            inset: '0',
            zIndex: '9998',
            backdropFilter: 'blur(8px)',
            background: 'rgba(30, 34, 45, 0.25)',
            pointerEvents: 'auto'
        });

        // Create modal
        const modal = document.createElement('div');
        Object.assign(modal.style, {
            position: 'fixed',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            zIndex: '9999',
            background: 'linear-gradient(135deg, #ff512f 0%, #dd2476 100%)',
            borderRadius: '1.2rem',
            boxShadow: '0 8px 32px 0 rgba(220, 38, 38, 0.25)',
            padding: '2.5rem 2rem 2rem 2rem',
            minWidth: '340px',
            maxWidth: '90vw',
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            gap: '1.5rem',
            color: '#fff',
            fontFamily: 'Inter, Segoe UI, Arial, sans-serif'
        });

        modal.innerHTML = `
            <div style="display: flex; flex-direction: column; align-items: center;">
                <svg width="64" height="64" fill="none" viewBox="0 0 64 64">
                    <circle cx="32" cy="32" r="32" fill="url(#lockgrad)" />
                    <path d="M32 40a4 4 0 100-8 4 4 0 000 8z" fill="#fff"/>
                    <rect x="20" y="28" width="24" height="16" rx="4" stroke="#fff" stroke-width="3"/>
                    <path d="M24 28v-4a8 8 0 1116 0v4" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
                    <defs>
                        <linearGradient id="lockgrad" x1="0" y1="0" x2="64" y2="64" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#ff512f"/>
                            <stop offset="1" stop-color="#dd2476"/>
                        </linearGradient>
                    </defs>
                </svg>
                <h2 style="margin: 1.2rem 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; letter-spacing: 0.01em;">
                    Your profile is locked
                </h2>
                <p style="font-size: 1.05rem; color: #ffe0e0; margin: 0; text-align: center;">
                    You can't access your profile right now.
                </p>
            </div>
            <button id="locked-modal-ok-btn" style="
                margin-top: 1.5rem;
                padding: 0.7rem 2.2rem;
                font-size: 1.1rem;
                font-weight: 600;
                color: #fff;
                background: linear-gradient(90deg, #ff512f 0%, #dd2476 100%);
                border: none;
                border-radius: 0.7rem;
                box-shadow: 0 2px 8px rgba(220,38,38,0.15);
                cursor: pointer;
                transition: background 0.2s;
            ">OK</button>
        `;

        // Prevent scrolling and focus trapping
        document.body.style.overflow = 'hidden';
        modal.tabIndex = 0;
        modal.focus();

        const trapFocus = (e) => {
            if (!modal.contains(e.target)) {
                e.stopPropagation();
                modal.focus();
            }
        };

        const keyHandler = (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                e.stopPropagation();
            }
        };

        document.addEventListener('focus', trapFocus, true);
        window.addEventListener('keydown', keyHandler, true);

        // OK button handler
        modal.querySelector('#locked-modal-ok-btn').onclick = () => {
            document.body.removeChild(blurOverlay);
            document.body.removeChild(modal);
            document.body.style.overflow = '';
            document.removeEventListener('focus', trapFocus, true);
            window.removeEventListener('keydown', keyHandler, true);
            window.location.href = '/';
        };

        // Prevent interaction with overlay
        blurOverlay.onclick = blurOverlay.onmousedown = blurOverlay.onpointerdown = (e) => e.stopPropagation();

        document.body.appendChild(blurOverlay);
        document.body.appendChild(modal);
    }
}

/**
 * Chat System
 */
class ChatSystem {
    constructor(notificationSystem) {
        this.notifications = notificationSystem;
        this.state = {
            socket: null,
            userId: null,
            unreadCount: 0,
            isAdminOnline: false,
            isConnected: false,
            reconnectAttempts: 0,
            isDestroyed: false
        };

        this.elements = {
            chatButton: document.getElementById('chatButton'),
            chatModal: document.getElementById('chatModal'),
            closeChat: document.getElementById('closeChat'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendMessage'),
            chatHistory: document.getElementById('chatHistory'),
            unreadBadge: document.getElementById('unreadBadge'),
            adminStatusDot: document.getElementById('adminStatusDot'),
            adminStatusText: document.getElementById('adminStatusText')
        };

        this.init();
    }

    init() {
        this.bindEvents();
        this.connectWebSocket();
    }

    bindEvents() {
        if (!this.elements.chatButton) return;

        this.elements.chatButton.addEventListener('click', () => this.toggleChat());
        this.elements.closeChat?.addEventListener('click', () => this.closeChat());
        this.elements.sendButton?.addEventListener('click', () => this.sendMessage());

        this.elements.messageInput?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                this.sendMessage();
            }
        });

        this.elements.messageInput?.addEventListener('input', (e) => {
            this.autoResize(e.target);
        });

        window.addEventListener('beforeunload', () => this.destroy());
    }

    async connectWebSocket() {
        if (this.state.isDestroyed) return;

        const token = Utils.getAuthToken();
        if (!token) {
            this.showError('Authentication required. Please login.');
            return;
        }

        try {
            console.log('[Chat] Connecting to WebSocket...');
            this.state.socket = new WebSocket(CONFIG.WS_URL);

            this.state.socket.onopen = () => this.handleSocketOpen(token);
            this.state.socket.onmessage = (e) => this.handleSocketMessage(e);
            this.state.socket.onclose = () => this.handleSocketClose();
            this.state.socket.onerror = (err) => this.handleSocketError(err);

        } catch (error) {
            console.error('[Chat] Failed to create WebSocket connection:', error);
            this.showError('Failed to connect to chat service.');
        }
    }

    handleSocketOpen(token) {
        console.log('[Chat] WebSocket connected, authenticating...');
        this.state.isConnected = true;
        this.state.reconnectAttempts = 0;

        this.state.socket.send(JSON.stringify({ 
            type: 'auth', 
            token 
        }));
    }

    handleSocketMessage(event) {
        try {
            const data = JSON.parse(event.data);
            console.log('[Chat] Received message:', data.type);

            switch (data.type) {
                case 'authSuccess':
                    this.handleAuthSuccess(data);
                    break;
                case 'chatHistory':
                    this.handleChatHistory(data);
                    break;
                case 'newChatMessage':
                    this.handleNewMessage(data);
                    break;
                case 'adminStatusUpdate':
                    this.updateAdminStatus(data.isAdminOnline);
                    break;
                case 'error':
                    this.showError(`Server error: ${data.message}`);
                    break;
                default:
                    console.warn('[Chat] Unknown message type:', data.type);
            }
        } catch (error) {
            console.error('[Chat] Failed to parse WebSocket message:', error);
        }
    }

    handleSocketClose() {
        console.warn('[Chat] WebSocket connection closed');
        this.state.isConnected = false;
        this.updateAdminStatus(false, 'Disconnected');
        
        if (this.elements.sendButton) {
            this.elements.sendButton.disabled = true;
        }

        if (!this.state.isDestroyed && this.state.reconnectAttempts < CONFIG.MAX_RECONNECT_ATTEMPTS) {
            this.state.reconnectAttempts++;
            console.log(`[Chat] Reconnecting... Attempt ${this.state.reconnectAttempts}`);
            setTimeout(() => this.connectWebSocket(), CONFIG.RECONNECT_DELAY);
        }
    }

    handleSocketError(error) {
        console.error('[Chat] WebSocket error:', error);
        this.showError('Connection error. Trying to reconnect...');
    }

    handleAuthSuccess(data) {
        this.state.userId = data.userId;
        if (this.elements.sendButton) {
            this.elements.sendButton.disabled = false;
        }
        console.log('[Chat] Authenticated successfully');
        this.fetchChatHistory();
    }

    handleChatHistory(data) {
        this.clearChatHistory();
        if (Array.isArray(data.messages)) {
            data.messages.forEach(msg => this.renderMessage(msg));
        }
        this.scrollToBottom();
        this.markMessagesAsRead();
    }

    handleNewMessage(data) {
        const msg = data.message;
        this.renderMessage(msg);

        const senderActualId = this.extractSenderId(msg);
        const isOwnMessage = senderActualId === this.state.userId;
        const modalOpen = this.elements.chatModal?.classList.contains('active');

        if (!isOwnMessage && !modalOpen) {
            this.state.unreadCount++;
            this.updateUnreadBadge();
        } else if (modalOpen) {
            this.markMessagesAsRead();
        }
    }

    async fetchChatHistory() {
        try {
            const response = await fetch(
                `${CONFIG.API_BASE}/history/${CONFIG.PRIMARY_CHAT_ADMIN_ID}`,
                {
                    headers: {
                        'Authorization': `Bearer ${Utils.getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                }
            );

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (!Array.isArray(result.data)) {
                throw new Error('Invalid chat history format');
            }

            this.handleChatHistory({ messages: result.data });

        } catch (error) {
            console.error('[Chat] Failed to fetch chat history:', error);
            this.showError('Failed to load chat history.');
        }
    }

    async markMessagesAsRead() {
        if (!this.state.isConnected || !this.state.userId) return;

        try {
            const response = await fetch(CONFIG.ENDPOINTS.MARK_READ, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${Utils.getAuthToken()}`
                },
                body: JSON.stringify({ 
                    otherUserId: CONFIG.PRIMARY_CHAT_ADMIN_ID 
                })
            });

            if (response.ok) {
                this.state.unreadCount = 0;
                this.updateUnreadBadge();
            }
        } catch (error) {
            console.error('[Chat] Failed to mark messages as read:', error);
        }
    }

    async sendMessage() {
        if (!this.elements.messageInput) return;

        const text = this.elements.messageInput.value.trim();
        if (!text || !this.state.isConnected) return;

        // Disable send button temporarily
        if (this.elements.sendButton) {
            this.elements.sendButton.disabled = true;
        }

        // Optimistic UI update
        this.renderMessage({
            senderId: this.state.userId,
            messageContent: text,
            createdAt: new Date()
        });

        // Clear input
        this.elements.messageInput.value = '';
        this.autoResize(this.elements.messageInput);

        try {
            const response = await fetch(CONFIG.ENDPOINTS.SEND_MESSAGE, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${Utils.getAuthToken()}`
                },
                body: JSON.stringify({ messageContent: text })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || 'Failed to send message');
            }

        } catch (error) {
            console.error('[Chat] Failed to send message:', error);
            this.showError('Failed to send message. Please try again.');
        } finally {
            if (this.elements.sendButton) {
                this.elements.sendButton.disabled = !this.state.isConnected;
            }
        }
    }

    renderMessage(msg) {
        if (!this.elements.chatHistory) return;

        const senderActualId = this.extractSenderId(msg);
        const isUser = senderActualId === this.state.userId;

        const messageEl = document.createElement('div');
        messageEl.classList.add('message', isUser ? 'user-message' : 'admin-message');

        const time = new Date(msg.createdAt)
            .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const safeContent = Utils.escapeHtml(msg.messageContent);

        messageEl.innerHTML = `
            ${safeContent}
            <div class="message-time">${time}</div>
        `;

        this.elements.chatHistory.appendChild(messageEl);
        this.scrollToBottom();
    }

    toggleChat() {
        if (!this.elements.chatModal) return;

        const isActive = this.elements.chatModal.classList.contains('active');

        if (isActive) {
            this.closeChat();
        } else {
            this.openChat();
        }
    }

    openChat() {
        if (!this.elements.chatModal) return;

        this.elements.chatModal.classList.add('active');
        this.elements.messageInput?.focus();

        if (this.state.unreadCount > 0) {
            this.markMessagesAsRead();
        }

        this.scrollToBottom();
    }

    closeChat() {
        if (!this.elements.chatModal) return;
        this.elements.chatModal.classList.remove('active');
    }

    scrollToBottom() {
        if (!this.elements.chatHistory) return;

        requestAnimationFrame(() => {
            this.elements.chatHistory.scrollTop = this.elements.chatHistory.scrollHeight;
        });
    }

    updateUnreadBadge() {
        if (!this.elements.unreadBadge) return;

        if (this.state.unreadCount > 0) {
            this.elements.unreadBadge.textContent = this.state.unreadCount > 99 ? '99+' : this.state.unreadCount;
            this.elements.unreadBadge.style.display = 'flex';
        } else {
            this.elements.unreadBadge.style.display = 'none';
        }
    }

    updateAdminStatus(isOnline, customText = null) {
        this.state.isAdminOnline = isOnline;

        if (this.elements.adminStatusDot) {
            this.elements.adminStatusDot.className = `status-dot ${isOnline ? 'status-online' : ''}`;
            if (isOnline) {
                this.elements.adminStatusDot.classList.add('pulse');
            }
        }

        if (this.elements.adminStatusText) {
            this.elements.adminStatusText.textContent = customText || (isOnline ? 'Online' : 'Offline');
        }
    }

    autoResize(textarea) {
        if (!textarea) return;
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
    }

    clearChatHistory() {
        if (this.elements.chatHistory) {
            this.elements.chatHistory.innerHTML = '';
        }
    }

    showError(message) {
        if (!this.elements.chatHistory) return;

        const errorEl = document.createElement('div');
        errorEl.className = 'error-message';
        errorEl.textContent = message;

        // Remove existing error messages
        const existingErrors = this.elements.chatHistory.querySelectorAll('.error-message');
        existingErrors.forEach(el => el.remove());

        this.elements.chatHistory.appendChild(errorEl);
        this.scrollToBottom();

        // Auto-remove after timeout
        setTimeout(() => {
            if (errorEl.parentNode) {
                errorEl.remove();
            }
        }, CONFIG.ERROR_DISPLAY_TIMEOUT);
    }

    extractSenderId(msg) {
        return msg.senderId && msg.senderId._id ? msg.senderId._id : msg.senderId;
    }

    destroy() {
        console.log('[Chat] Destroying chat system...');
        this.state.isDestroyed = true;

        if (this.state.socket) {
            this.state.socket.close();
            this.state.socket = null;
        }
    }
}

/**
 * Transaction Password Manager
 */
class TransactionPasswordManager {
    constructor(notificationSystem) {
        this.notifications = notificationSystem;
        this.modal = document.getElementById('transactionPassModal');
        this.form = document.getElementById('transactionForm');
        
        this.bindEvents();
    }

    bindEvents() {
        if (!this.form) return;

        this.form.addEventListener('submit', (e) => this.handleSubmit(e));

        // Close modal when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    const form = modal.querySelector('form');
                    if (form) form.reset();
                }
            });
        });
    }

    show() {
        if (this.modal) {
            this.modal.style.display = 'flex';
        }
    }

    hide() {
        if (this.modal) {
            this.modal.style.display = 'none';
            if (this.form) this.form.reset();
        }
    }

    async handleSubmit(e) {
        e.preventDefault();
        
        const passwordInput = document.getElementById('trxPassword');
        const submitButton = e.target.querySelector('button[type="submit"]');
        
        if (!passwordInput || !submitButton) return;

        const password = passwordInput.value;
        const originalText = submitButton.textContent;
        
        // Update button state
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

        try {
            const response = await fetch(CONFIG.ENDPOINTS.SET_TRX_PASSWORD, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ trxPass: password })
            });

            const data = await response.json();

            if (response.ok) {
                this.notifications.success(data.message || 'Transaction password set successfully!');
                this.hide();
            } else {
                this.notifications.error(data.message || 'Error setting transaction password');
            }

        } catch (error) {
            console.error('[TransactionPassword] Network error:', error);
            this.notifications.error('Network error. Please try again.');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        }
    }
}

/**
 * Context Menu Manager
 */
class ContextMenuManager {
    constructor(transactionPasswordManager) {
        this.transactionPasswordManager = transactionPasswordManager;
        this.menuButton = document.getElementById('mainMenuBtn');
        this.contextMenu = document.getElementById('contextMenu');
        
        this.bindEvents();
    }

    bindEvents() {
        if (!this.menuButton || !this.contextMenu) return;

        // Toggle context menu
        this.menuButton.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleMenu();
        });

        // Menu item actions
        const kycMenuItem = document.getElementById('kyc-verification');
        const setTrxPasswordMenuItem = document.getElementById('setTrxPassword');

        kycMenuItem?.addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = './kyc-verification.html';
        });

        setTrxPasswordMenuItem?.addEventListener('click', () => {
            this.transactionPasswordManager.show();
            this.hideMenu();
        });

        // Close menu on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#mainMenuBtn') && !e.target.closest('#contextMenu')) {
                this.hideMenu();
            }
        });
    }

    toggleMenu() {
        const isVisible = this.contextMenu.style.display === 'block';
        
        if (isVisible) {
            this.hideMenu();
        } else {
            this.showMenu();
        }
    }

    showMenu() {
        const rect = this.menuButton.getBoundingClientRect();
        this.contextMenu.style.display = 'block';
        this.contextMenu.style.top = `${rect.bottom + window.scrollY}px`;
        this.contextMenu.style.right = `${window.innerWidth - rect.right}px`;
    }

    hideMenu() {
        this.contextMenu.style.display = 'none';
    }
}

/**
 * Tab System Manager
 */
class TabManager {
    constructor() {
        this.contractContainer = document.querySelector('#contracts .transaction-cards');
        this.optionContainer = document.querySelector('#options .transaction-cards');
        
        this.bindEvents();
        this.loadInitialTab();
    }

    bindEvents() {
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = btn.dataset.tabTarget;
                
                // Update active states
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                const targetTab = document.getElementById(target);
                if (targetTab) targetTab.classList.add('active');

                // Load content based on tab
                if (target === 'contracts') {
                    this.loadCompletedContracts();
                } else if (target === 'options') {
                    this.loadCompletedOptions();
                }
            });
        });

        // Delegate expand/collapse functionality
        this.delegateExpand(this.contractContainer);
        this.delegateExpand(this.optionContainer);
    }

    loadInitialTab() {
        const activeTab = document.querySelector('.tab-btn.active');
        if (activeTab?.dataset.tabTarget === 'contracts') {
            this.loadCompletedContracts();
        }
    }

    async loadCompletedContracts() {
        if (!this.contractContainer) return;

        try {
            const response = await fetch(CONFIG.ENDPOINTS.COMPLETED_CONTRACTS);
            const json = await response.json();

            if (!json.success || !Array.isArray(json.data.trades)) {
                this.contractContainer.innerHTML = '<p>No completed contract trades.</p>';
                return;
            }

            this.contractContainer.innerHTML = '';

            json.data.trades.forEach(position => {
                const {
                    assetPair, direction, openingPrice, quantity,
                    leverage, takeProfitPrice, stopLossPrice,
                    closingPrice, closingTime, realizedPnl
                } = position;

                const pnlClass = Utils.calculatePnlClass(realizedPnl);
                const pnlSign = Utils.formatPnlSign(realizedPnl);
                const assetSymbol = Utils.extractAssetSymbol(assetPair);
                const closedAt = Utils.formatDate(closingTime);

                this.contractContainer.insertAdjacentHTML('beforeend', `
                    <div class="transaction-card">
                        <div class="card-header">
                            <span class="asset-symbol">${assetSymbol}</span>
                            <span class="asset-change ${pnlClass}">${pnlSign}${realizedPnl.toFixed(2)}</span>
                        </div>
                        <div class="card-body">
                            <div class="basic-info">
                                <div class="asset-info">
                                    <div class="asset-name">${direction} Position ×${quantity}</div>
                                    <div class="asset-quantity">Quantity: ${quantity}</div>
                                </div>
                                <div class="asset-pricing">
                                    <div class="price-item"><span>Position Price:</span><span>${openingPrice}</span></div>
                                    <div class="price-item"><span>Leverage:</span><span>${leverage}x</span></div>
                                </div>
                            </div>
                            <div class="advanced-details">
                                ${takeProfitPrice != null ? `<div class="price-item"><span>Take Profit:</span><span>${takeProfitPrice}</span></div>` : ''}
                                ${stopLossPrice != null ? `<div class="price-item"><span>Stop Loss:</span><span>${stopLossPrice}</span></div>` : ''}
                                <div class="price-item"><span>Closing Price:</span><span>${closingPrice}</span></div>
                                <div class="price-item"><span>Closed At:</span><span>${closedAt}</span></div>
                            </div>
                        </div>
                        <div class="expand-control"><span>View Details</span></div>
                    </div>
                `);
            });

        } catch (error) {
            console.error('[Contracts] Load error:', error);
            this.contractContainer.innerHTML = '<p>Error loading completed contract trades.</p>';
        }
    }

    async loadCompletedOptions() {
        if (!this.optionContainer) return;

        try {
            const response = await fetch(CONFIG.ENDPOINTS.OPTION_TRADES);
            const json = await response.json();

            if (!json.success || !Array.isArray(json.data.trades)) {
                this.optionContainer.innerHTML = '<p>No option trades.</p>';
                return;
            }

            const completedTrades = json.data.trades.filter(trade => trade.status !== 'Active');

            if (completedTrades.length === 0) {
                this.optionContainer.innerHTML = '<p>No completed option trades.</p>';
                return;
            }

            this.optionContainer.innerHTML = '';

            completedTrades.forEach(trade => {
                const {
                    assetPair, direction, investmentAmount,
                    openingPrice, durationSeconds, returnPercentage,
                    outcome, payoutAmount, expiryPrice,
                    purchaseTime
                } = trade;

                const profit = payoutAmount - investmentAmount;
                const pnlClass = Utils.calculatePnlClass(profit);
                const pnlSign = Utils.formatPnlSign(profit);
                const assetSymbol = Utils.extractAssetSymbol(assetPair);
                const purchaseAt = Utils.formatDate(purchaseTime);

                this.optionContainer.insertAdjacentHTML('beforeend', `
                    <div class="transaction-card">
                        <div class="card-header">
                            <span class="asset-symbol">${assetSymbol}</span>
                            <span class="asset-change ${pnlClass}">${pnlSign}${profit.toFixed(2)}</span>
                        </div>
                        <div class="card-body">
                            <div class="basic-info">
                                <div class="asset-info">
                                    <div class="asset-name">Opening Price : ${openingPrice}</div>
                                    <div class="asset-quantity">Quantity: ${investmentAmount}</div>
                                </div>
                                <div class="asset-pricing">
                                    <div class="price-item"><span>Settlement Price:</span><span>${expiryPrice != null ? expiryPrice : ''}</span></div>
                                    <div class="price-item"><span>Delivery Time:</span><span>${durationSeconds}s</span></div>
                                </div>
                            </div>
                            <div class="advanced-details">
                                <div class="price-item"><span>Profit and Loss:</span><span>${profit.toFixed(2)}</span></div>
                                <div class="price-item"><span>Direction:</span><span class="${outcome === 'Win' ? 'positive' : 'negative'}">${direction}</span></div>
                                <div class="price-item"><span>Order Time</span><span>${purchaseAt}</span></div>
                            </div>
                        </div>
                        <div class="expand-control"><span>View Details</span></div>
                    </div>
                `);
            });

        } catch (error) {
            console.error('[Options] Load error:', error);
            this.optionContainer.innerHTML = '<p>Error loading completed option trades.</p>';
        }
    }

    delegateExpand(container) {
        if (!container) return;

        container.addEventListener('click', (e) => {
            const control = e.target.closest('.expand-control');
            if (!control) return;

            const card = control.closest('.transaction-card');
            const details = card.querySelector('.advanced-details');
            const label = control.querySelector('span');

            if (!details || !label) return;

            details.classList.toggle('active');
            label.textContent = details.classList.contains('active') ? 'Hide Details' : 'View Details';

            if (details.classList.contains('active')) {
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        });
    }
}

/**
 * Navigation Manager
 */
class NavigationManager {
    constructor() {
        this.bindEvents();
    }

    bindEvents() {
        // Quick action navigation
        const navigationMap = {
            'kyc': './kyc-verification.html',
            'update-profile-div': './update-profile.html',
            'trx-record': './transaction-history.html',
            'loan-history': './loan.html',
            'depositBtn': './add-fund.html',
            'withdrawBtn': './withdraw.html'
        };

        Object.entries(navigationMap).forEach(([id, url]) => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = url;
                });
            }
        });
    }
}

/**
 * Application Controller
 */
class ProfileApp {
    constructor() {
        this.notifications = new NotificationSystem();
        this.profileManager = new ProfileManager(this.notifications);
        this.chatSystem = new ChatSystem(this.notifications);
        this.transactionPasswordManager = new TransactionPasswordManager(this.notifications);
        this.contextMenuManager = new ContextMenuManager(this.transactionPasswordManager);
        this.tabManager = new TabManager();
        this.navigationManager = new NavigationManager();

        this.init();
    }

    async init() {
        try {
            await this.profileManager.fetchAndUpdate();
        } catch (error) {
            console.error('[App] Initialization error:', error);
            this.notifications.error('Failed to initialize application');
        }
    }

    destroy() {
        this.chatSystem.destroy();
    }
}

/**
 * Application Initialization
 */
function initializeApp() {
    if (window.profileApp) {
        window.profileApp.destroy();
    }
    
    window.profileApp = new ProfileApp();
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    // DOM already loaded
    initializeApp();
}

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (window.profileApp) {
        window.profileApp.destroy();
    }
});

// Tab reordering and default selection
document.addEventListener('DOMContentLoaded', function() {
    const tabsHeader = document.querySelector('.tabs-header');
    const contractsTab = document.querySelector('.tab-btn[data-tab-target="contracts"]');
    const optionsTab = document.querySelector('.tab-btn[data-tab-target="options"]');
    
    if (tabsHeader && contractsTab && optionsTab) {
        // Reorder tabs - move options to the left (first position)
        tabsHeader.insertBefore(optionsTab, contractsTab);
        
        // Remove active class from contracts tab and add to options tab
        contractsTab.classList.remove('active');
        optionsTab.classList.add('active');
        
        // Switch the content visibility
        const contractsContent = document.getElementById('contracts');
        const optionsContent = document.getElementById('options');
        
        if (contractsContent && optionsContent) {
            contractsContent.classList.remove('active');
            optionsContent.classList.add('active');
        }
        
        // Trigger the options tab load if the TabManager exists
        if (window.profileApp && window.profileApp.tabManager) {
            window.profileApp.tabManager.loadCompletedOptions();
        }
    }
});
</script>
 

  </body>
</html>