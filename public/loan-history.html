<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Assets</title>
    <link rel="stylesheet" href="./css/homepage.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./css/loan-history.css">
    <link rel="icon" type="image/x-icon" href="./Images/favicon.ico">
    <style>
  /* Modal backdrop */
  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }
  /* Modal window */
  .modal {
    background: #fff;
    padding: 1.5rem;
    border-radius: 1rem;
    width: 90%;
    max-width: 400px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
  }
  .modal h2 {
    margin-top: 0;
  }
  .modal input {
    width: 100%;
    padding: 0.75rem;
    margin: 1rem 0;
    border-radius: 0.5rem;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  .modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }
  .btn-cancel, .btn-repay {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 0.9rem;
  }
  .btn-cancel {
    background: #eee;
  }
  .btn-repay {
    background: #2a9d8f;
    color: #fff;
  }

  /* Toast */
  .custom-toast {
    position: fixed;
    top: 1rem;
    right: 1rem;
    background: #2a9d8f;
    color: #fff;
    padding: 1rem 1.5rem;
    border-radius: 0.75rem;
    opacity: 0;
    transform: translateY(-20px);
    transition: all 0.3s;
    z-index: 1100;
  }
  .custom-toast.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .custom-toast.error {
    background: #e76f51;
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 1rem 0;
    gap: 0.5rem;
  }
  .pagination button {
    padding: 0.4rem 0.8rem;
    border: none;
    background: #264653;
    color: #fff;
    border-radius: 0.5rem;
    cursor: pointer;
  }
  .pagination button:hover {
    background: #1b3330;
  }
    </style>
    
</head>
<body>
<header id="header">
    <div class="header-container">
        <div class="nav-menu">
            <div class="logo-container">
               <a href="./"> <img src="./Images/home_logo.png" alt="Company Logo"> </a>
            </div>
            <nav class="desktop-nav">
                <a href="./" class="nav-item">Home</a>
                <a href="./market.html" class="nav-item">Market</a>
                <a href="./ai-finance.html" class="nav-item">AI Finance</a>
                <a href="./loan.html" class="nav-item">Loans</a>
                <a href="./profile.html" class="nav-item">Account</a>
            </nav>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn sign-up-btn">Sign Up</button>
            <button id="nav-black-btn" class="nav-btn sign-in-btn">Sign In</button>
        </div>

        <button class="mobile-menu-toggle">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
         <a href="./" class="nav-item">Home</a>
         <a href="./market.html" class="nav-item">Market</a>
         <a href="./ai-finance.html" class="nav-item">AI Finance</a>
         <a href="./loan.html" class="nav-item">Loans</a>
         <a href="./profile.html" class="nav-item">Account</a>
        <div class="nav-buttons">
            <button class="nav-btn sign-up-btn">  Sign Up</button>
            <button id="nav-black-btn" class="nav-btn sign-in-btn">Sign In</button>
        </div>
    </nav>
  </header>

  <!-- Loan History Section -->
<div class="loan-hist__wrapper">
    <h2 class="loan-hist__title">Loan History</h2>
    
     <div class="loan-list">

            <div class="loan-card">
                <div class="loan-header">
                    <div class="loan-id">No.202506042011544949</div>
                    <div class="loan-status status-approved">Approved</div>
                </div>
                
                <div class="loan-main">
                    <div class="loan-summary">
                        <div class="loan-amount">$500,330.0000 USD</div>
                        <div class="loan-meta">
                            <div class="loan-meta-item">
                                <i class="fas fa-calendar-alt"></i>
                                <span>30 Days</span>
                            </div>
                            <div class="loan-meta-item">
                                <i class="fas fa-percentage"></i>
                                <span>0.0660% Daily</span>
                            </div>
                            <div class="loan-meta-item">
                                <i class="fas fa-hand-holding-usd"></i>
                                <span>$330.0000 Interest</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="loan-details">
                        <div class="detail-item">
                            <span class="detail-label">Loan Term</span>
                            <div class="detail-value">30 Days</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Total Repayment</span>
                            <div class="detail-value">$500,330.0000 USD</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Amount to Repay</span>
                            <div class="detail-value">$500,330.0000 USD</div>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Late Fee</span>
                            <div class="detail-value">$0.0000 USD</div>
                        </div>
                    </div>
                </div>
                
                <div class="loan-timeline">
                    <div class="timeline-item">
                        <div class="timeline-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Order Time</h4>
                            <p>2025-06-05 08:13:41</p>
                        </div>
                    </div>
                    
                    <div class="timeline-item">
                        <div class="timeline-icon">
            <i class="fas fa-clock"></i>
                        </div>
                        <div class="timeline-content">
                            <h4>Repayment Date</h4>
                            <p>2025-07-05 08:13:41</p>
                        </div>
                    </div>
                </div>
                
                <div class="loan-actions">
                    <div class="action-info">
                        <h3>Ready to repay your loan?</h3>
                        <p>Complete your repayment to avoid late fees</p>
                    </div>
                    <button class="action-button">
                        <i class="fas fa-wallet"></i> Repay Now
                    </button>
                </div>
            </div>
            
            <!-- Loan Card 2 - Approved -->
            <div class="loan-card">
                <div class="loan-header">
                    <div class="loan-id">No.202506072215678901</div>
                    <div class="loan-status status-approved">Approved</div>
                </div>
                
              <div class="loan-main">
                <div class="loan-summary">
                    <div class="loan-amount">$500,330.0000 USD</div>
                    <div class="loan-meta">
                        <div class="loan-meta-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span>30 Days</span>
                        </div>
                        <div class="loan-meta-item">
                            <i class="fas fa-percentage"></i>
                            <span>0.0660% Daily</span>
                        </div>
                        <div class="loan-meta-item">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span>$330.0000 Interest</span>
                        </div>
                    </div>
                </div>

                <div class="loan-details">
                    <div class="detail-item">
                        <span class="detail-label">Loan Term</span>
                        <div class="detail-value">30 Days</div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Repayment</span>
                        <div class="detail-value">$500,330.0000 USD</div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Amount to Repay</span>
                        <div class="detail-value">$500,330.0000 USD</div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Late Fee</span>
                        <div class="detail-value">$0.0000 USD</div>
                    </div>
                </div>
              </div>

              <div class="loan-timeline">
                <div class="timeline-item">
                    <div class="timeline-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Order Time</h4>
                        <p>2025-06-05 08:13:41</p>
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="timeline-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Repayment Date</h4>
                        <p>2025-07-05 08:13:41</p>
                    </div>
                </div>
              </div>

              <div class="loan-actions">
                <div class="action-info">
                    <h3>Ready to repay your loan?</h3>
                    <p>Complete your repayment to avoid late fees</p>
                </div>
                <button class="action-button">
                    <i class="fas fa-wallet"></i> Repay Now
                </button>
              </div>
            </div>
            
            <!-- Loan Card 3 - Repaid -->
            <div class="loan-card">
                <div class="loan-header">
                    <div class="loan-id">No.202505151045329876</div>
                    <div class="loan-status status-repaid">Repaid</div>
                </div>
                
              <div class="loan-main">
                <div class="loan-summary">
                    <div class="loan-amount">$500,330.0000 USD</div>
                    <div class="loan-meta">
                        <div class="loan-meta-item">
                            <i class="fas fa-calendar-alt"></i>
                            <span>30 Days</span>
                        </div>
                        <div class="loan-meta-item">
                            <i class="fas fa-percentage"></i>
                            <span>0.0660% Daily</span>
                        </div>
                        <div class="loan-meta-item">
                            <i class="fas fa-hand-holding-usd"></i>
                            <span>$330.0000 Interest</span>
                        </div>
                    </div>
                </div>

                <div class="loan-details">
                    <div class="detail-item">
                        <span class="detail-label">Loan Term</span>
                        <div class="detail-value">30 Days</div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Repayment</span>
                        <div class="detail-value">$500,330.0000 USD</div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Amount to Repay</span>
                        <div class="detail-value">$500,330.0000 USD</div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Late Fee</span>
                        <div class="detail-value">$0.0000 USD</div>
                    </div>
                </div>
              </div>

              <div class="loan-timeline">
                <div class="timeline-item">
                    <div class="timeline-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Order Time</h4>
                        <p>2025-06-05 08:13:41</p>
                    </div>
                </div>

                <div class="timeline-item">
                    <div class="timeline-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="timeline-content">
                        <h4>Repayment Date</h4>
                        <p>2025-07-05 08:13:41</p>
                    </div>
                </div>
              </div>

            </div>
        </div>
</div>

  <footer class="footer">
    <div class="footer-content">
      <!-- Logo / Brand -->
      <div class="footer-section logo-section">
        <img src="./Images/logo_foot.png" alt="Global Assets Logo" class="footer-logo">
      </div>
      <!-- Company -->
      <div class="footer-section">
        <h4>Company</h4>
        <ul>
          <li><a href="./about.html">About Us</a></li>
          <li><a href="./team.html">About the Team</a></li>
          <li><a href="./faq.html">Help Center</a></li>
          <li><a href="#">Email support</a></li>
          <li><a href="mailto:service@global-assets.com">service@global‑assets.io</a></li>
        </ul>
      </div>
      <!-- Product -->
      <div class="footer-section">
        <h4>Product</h4>
        <ul>
          <li><a href="./market.html">Market List</a></li>
          <li><a href="./loan.html">Investment loans</a></li>
          <li><a href="./ai-finance.html">AI Finance</a></li>
        </ul>
      </div>
      <!-- Policy -->
      <div class="footer-section">
        <h4>Policy</h4>
        <ul>
          <li><a href="./agrt.html">User Services Agreement</a></li>
          <li><a href="./loan-agrt.html">Loan agreement</a></li>
          <li><a href="./loan-explain.html">Loan rules explanation</a></li>
          <li><a href="./legal-liability.html">Legal liability</a></li>
        </ul>
      </div>
      <!-- Statement -->
      <div class="footer-section">
        <h4>Statement</h4>
        <ul>
          <li><a href="./risk.html">Risk Warning</a></li>
          <li><a href="./privacy-statement.html">Privacy Statement</a></li>
          <li><a href="./anti-laundaring.html">Anti‑Money Laundering Policy</a></li>
          <li><a href="./rglt-licence.html">Regulatory license</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      &copy; Copyright 2016 – 2025 Global Assets. All rights reserved.
    </div>
  </footer>

   <script src="./javascript/common-script.js"></script>
  

<script>
document.addEventListener('DOMContentLoaded', function() {
  var listEl = document.querySelector('.loan-list');
  var wrapperEl = document.querySelector('.loan-hist__wrapper');
  var pageSize = 5;
  var loans = [];
  var currentPage = 1;

  // Toast helper
  function showToast(message, isError) {
    isError = !!isError;
    var toast = document.createElement('div');
    toast.className = 'custom-toast' + (isError ? ' error' : '');
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(function() { toast.classList.add('visible'); }, 10);
    setTimeout(function() { toast.classList.remove('visible'); }, 4000);
    setTimeout(function() {
      if (toast.parentNode) toast.parentNode.removeChild(toast);
    }, 4500);
  }

  // Open repay modal
  function openRepayModal(loanId) {
    var backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';

    var modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = '\
      <h2>Repay Loan</h2>\
      <input type="number" min="0" placeholder="Amount to repay" class="repay-input" />\
      <div class="modal-actions">\
        <button class="btn-cancel">Cancel</button>\
        <button class="btn-repay">Repay</button>\
      </div>';

    backdrop.appendChild(modal);
    document.body.appendChild(backdrop);

    backdrop.querySelector('.btn-cancel').addEventListener('click', function() {
      document.body.removeChild(backdrop);
    });

    backdrop.querySelector('.btn-repay').addEventListener('click', function() {
      var amt = backdrop.querySelector('.repay-input').value;
      if (!amt || isNaN(amt) || Number(amt) <= 0) {
        showToast('Please enter a valid amount', true);
        return;
      }
      // Post repayment
      fetch('/api/v1/users/' + loanId + '/repay', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ amount: amt })
      }).then(function(res){ return res.json(); })
        .then(function(json) {
          if (json.success) {
            showToast(json.message);
            document.body.removeChild(backdrop);
            loadLoans(currentPage);
          } else {
            throw new Error(json.message || 'Repayment failed');
          }
        })
        .catch(function(err) {
          showToast(err.message, true);
        });
    });
  }

  // Create one loan card element
function renderLoanCard(loan) {
  var statusClasses = {
    'Approved': ['status-approved', 'Approved'],
    'PendingApproval': ['status-pending', 'Pending'],
    'Repaid': ['status-repaid', 'Repaid']
  };
  var sc = statusClasses[loan.status] || ['', loan.status];
  var orderTime = loan.loanDate ? new Date(loan.loanDate).toLocaleString() : '—';
  var dueTime = loan.dueDate ? new Date(loan.dueDate).toLocaleString() : '—';

  var card = document.createElement('div');
  card.className = 'loan-card';
  card.innerHTML = '\
    <div class="loan-header">\
      <div class="loan-id">No.' + loan._id + '</div>\
      <div class="loan-status ' + sc[0] + '">' + sc[1] + '</div>\
    </div>\
    <div class="loan-main">\
      <div class="loan-summary">\
        <div class="loan-amount">$' + loan.loanAmount.toFixed(4) + ' USD</div>\
        <div class="loan-meta">\
          <div class="loan-meta-item"><i class="fas fa-calendar-alt"></i><span>' + loan.loanTermDays + ' Days</span></div>\
          <div class="loan-meta-item"><i class="fas fa-percentage"></i><span>' + (loan.dailyInterestRate).toFixed(4) + '% Daily</span></div>\
          <div class="loan-meta-item"><i class="fas fa-hand-holding-usd"></i><span>$' + loan.accruedInterest.toFixed(4) + ' Interest</span></div>\
        </div>\
      </div>\
      <div class="loan-details">\
        <div class="detail-item"><span class="detail-label">Loan Term</span><div class="detail-value">' + loan.loanTermDays + ' Days</div></div>\
        <div class="detail-item"><span class="detail-label">Total Repayment</span><div class="detail-value">$' + (loan.loanAmount + loan.accruedInterest).toFixed(4) + ' USD</div></div>\
        <div class="detail-item"><span class="detail-label">Amount to Repay</span><div class="detail-value">$' + loan.outstandingPrincipal.toFixed(4) + ' USD</div></div>\
        <div class="detail-item"><span class="detail-label">Late Fee</span><div class="detail-value">$' + loan.latePaymentFeesAccrued.toFixed(4) + ' USD</div></div>\
      </div>\
    </div>\
    <div class="loan-timeline">\
      <div class="timeline-item"><div class="timeline-icon"><i class="fas fa-check-circle"></i></div><div class="timeline-content"><h4>Order Time</h4><p>' + orderTime + '</p></div></div>\
      <div class="timeline-item"><div class="timeline-icon"><i class="fas fa-clock"></i></div><div class="timeline-content"><h4>Repayment Date</h4><p>' + dueTime + '</p></div></div>\
    </div>' +
    // Start of the conditional block for the entire loan-actions section
    (loan.status === 'Approved'
      ? '<div class="loan-actions">\
          <div class="action-info">\
            <h3>Ready to repay your loan?</h3>\
            <p>Complete your repayment to avoid late fees</p>\
          </div>\
          <button class="action-button repay-btn">\
            <i class="fas fa-wallet"></i> Repay Now\
          </button>\
        </div>'
      : ''
    ) +
  '';

  if (loan.status === 'Approved') {
    card.querySelector('.repay-btn').addEventListener('click', function() {
      openRepayModal(loan._id);
    });
  }
  return card;
}

  // Render loans + pagination
  function renderPage(page) {
    listEl.innerHTML = '';
    var start = (page - 1)*pageSize;
    var chunk = loans.slice(start, start + pageSize);
    chunk.forEach(function(l){ listEl.appendChild(renderLoanCard(l)); });

    // pagination buttons
    var total = Math.ceil(loans.length / pageSize);
    var pag = wrapperEl.querySelector('.pagination');
    if (pag) pag.remove();

    pag = document.createElement('div');
    pag.className = 'pagination';
    if (page > 1) {
      var prev = document.createElement('button');
      prev.textContent = '« Prev';
      prev.addEventListener('click', function(){ loadLoans(page-1); });
      pag.appendChild(prev);
    }
    pag.appendChild(document.createTextNode(' Page ' + page + ' of ' + total + ' '));
    if (page < total) {
      var next = document.createElement('button');
      next.textContent = 'Next »';
      next.addEventListener('click', function(){ loadLoans(page+1); });
      pag.appendChild(next);
    }
    wrapperEl.appendChild(pag);
  }

  // Load loans (once) then render
  function loadLoans(page) {
    currentPage = page;
    if (loans.length === 0) {
      // fetch profile → loan history
      fetch('/api/v1/users/profile').then(r=>r.json()).then(function(pj){
        var uid = pj.data._id;
        return fetch('/api/v1/admin/user-loan-history', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({userId: uid})
        });
      }).then(r=>r.json()).then(function(hj){
        if (!hj.success) throw new Error(hj.message||'Failed to fetch loans');
        loans = hj.data.loans;
        renderPage(page);
      }).catch(function(err){
        showToast(err.message, true);
      });
    } else {
      renderPage(page);
    }
  }

  // initial
  loadLoans(1);
});
</script>

   


  </body>
</html>