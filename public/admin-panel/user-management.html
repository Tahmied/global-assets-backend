<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <link rel="stylesheet" href="./styles/user-management.css">
    <style>
        a {
            text-decoration: none;
            color: inherit;
        }
    </style>

</head>
<body>
    <button class="menu-btn" id="menuToggle">
        <ion-icon name="menu"></ion-icon>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="logo">
            <ion-icon name="rocket"></ion-icon>
           <a href="./admin.html">Global Assets</a> 
        </div>
        <div id="dashboard" class="nav-item">
            <ion-icon name="speedometer"></ion-icon>
           <a href="./admin.html">Dashboard</a> 
        </div>
        <div id="users" class="nav-item active">
            <ion-icon name="people"></ion-icon>
          <a href="./user-management.html">Users</a>  
        </div>
        <div id="transaction" class="nav-item">
            <ion-icon name="cash"></ion-icon>
           <a href="./transactions.html">Transactions</a> 
        </div>
        <div id="kyc-review" class="nav-item">
            <ion-icon name="document"></ion-icon>
           <a href="./kyc-review.html">KYC Review</a> 
        </div>
        <div id="loan-review" class="nav-item">
            <ion-icon name="card"></ion-icon>
            <a href="./loan-review.html">Loan Requests</a>
        </div>
        <div id="settings" class="nav-item">
            <ion-icon name="settings"></ion-icon>
           <a href="./settings.html">Settings</a> 
        </div>
        <div id="announcement" class="nav-item">
            <ion-icon name="megaphone"></ion-icon>
            <a href="./announcement.html">Publish Announcement</a>
        </div>
         <div id="announcement" class="nav-item">
            <ion-icon name="trending-up-outline"></ion-icon>
            <a href="./trades.html">Trades</a>
        </div>
         <div id="chats" class="nav-item">
             <ion-icon name="chatbubble"></ion-icon>
            <a href="./chat.html">Chats</a>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>User Management</h1>
            <div class="header-actions">
                <div class="search-bar">
                    <input type="text" placeholder="Search users...">
                    <ion-icon name="search"></ion-icon>
                </div>
            </div>
        </div>
    
        
    
        <div class="data-table">
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Joined</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
              <!-- users will be populated here by js -->
                </tbody>
            </table>
        </div>
    
        <div class="pagination">
            <button class="pagination-btn">
                <ion-icon name="chevron-back"></ion-icon>
            </button>
            <span class="active">1</span>
            <span>2</span>
            <span>3</span>
            <button class="pagination-btn">
                <ion-icon name="chevron-forward"></ion-icon>
            </button>
        </div>
    </div>

    <script src="admin-common.js"></script>
   <script>
  // Mobile Menu Toggle
  const menuToggle = document.getElementById('menuToggle');
  const sidebar = document.getElementById('sidebar');

  menuToggle.addEventListener('click', () => {
    sidebar.classList.toggle('active');
  });

  // Navigation Active State
  document.querySelectorAll('.nav-item').forEach((item) => {
    item.addEventListener('click', function () {
      document
        .querySelectorAll('.nav-item')
        .forEach((i) => i.classList.remove('active'));
      this.classList.add('active');
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    // State
    let currentPage = 1;
    const limit = 20;
    let totalPages = 1;
    let searchTerm = '';
    let debounceTimer;

    // Cache DOM
    const tableBody = document.querySelector('.data-table tbody');
    const paginationEl = document.querySelector('.pagination');
    const searchInput = document.querySelector('.search-bar input');

    // Fetch + render
    async function fetchAndRender() {
      const url = new URL('/api/v1/admin/list-users', window.location.origin);
      url.searchParams.set('page', currentPage);
      url.searchParams.set('limit', limit);
      if (searchTerm) url.searchParams.set('search', searchTerm);

      const res = await fetch(url);
      const { data } = await res.json();
      totalPages = data.lastPage;

      // Build rows
      tableBody.innerHTML = data.users
        .map((user) => {
          const name = `${user.firstName} ${user.lastName}`;
          const role = user.isAdmin ? 'Admin' : 'User';
          const status = user.isLocked ? 'Banned' : 'Active';
          const joined = new Date(user.createdAt).toLocaleDateString();
          const rawPath = user.dpLocalPath || '';   
          const raw = user.dpLocalPath || '';
          const candidate = raw
            .replace(/\\\\/g, '/')
            .replace(/^public/, '');
                  
          const finalSrc = candidate.trim() ? candidate : '../contents/profile.png';


          return `
            <tr>
              <td>
                <div class="user-info">
                  <img
                    src="${finalSrc}"
                    onerror="this.onerror=null; this.src='../contents/profile.png';"
                    class="user-avatar"
                    alt="User avatar"
                  />
                  <div class="user-details">
                    <div class="user-name">${name}</div>
                    <div class="user-id">#${user._id.slice(-5)}</div>
                  </div>
                </div>
              </td>
              <td>${user.email}</td>
              <td><span class="role-badge ${role.toLowerCase()}">${role}</span></td>
              <td><span class="status-badge ${status.toLowerCase()}">${status}</span></td>
              <td>${joined}</td>
              <td>
                <button class="icon-btn view-btn" data-id="${user._id}">
                  <ion-icon name="eye"></ion-icon>
                </button>
              </td>
            </tr>
          `;
        })
        .join('');

      renderPagination();
    }

    // Pagination UI
    function renderPagination() {
      let html = `
        <button class="pagination-btn" ${
          currentPage === 1 ? 'disabled' : ''
        } data-page="${currentPage - 1}">
          <ion-icon name="chevron-back"></ion-icon>
        </button>
      `;
      for (let p = 1; p <= totalPages; p++) {
        html += `<span class="${
          p === currentPage ? 'active' : ''
        }" data-page="${p}">${p}</span>`;
      }
      html += `
        <button class="pagination-btn" ${
          currentPage === totalPages ? 'disabled' : ''
        } data-page="${currentPage + 1}">
          <ion-icon name="chevron-forward"></ion-icon>
        </button>
      `;
      paginationEl.innerHTML = html;
    }

    // Event Listeners

    // Search (debounced)
    searchInput.addEventListener('input', (e) => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        searchTerm = e.target.value.trim();
        currentPage = 1;
        fetchAndRender();
      }, 300);
    });

    // Pagination click
    paginationEl.addEventListener('click', (e) => {
      const pg = e.target.closest('[data-page]')?.dataset.page;
      if (pg) {
        currentPage = Number(pg);
        fetchAndRender();
      }
    });

    // View details (delegate)
    tableBody.addEventListener('click', (e) => {
      const btn = e.target.closest('.view-btn');
      if (btn) {
        const userId = btn.dataset.id;
        window.location.href = `/admin/users/${userId}`;
      }
    });

    // Initial load
    fetchAndRender();
  });

  // Sidebar navigation
  document.querySelector('#users').addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = '/admin-panel/user-management.html';
  });

  document.querySelector('#dashboard').addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = '/admin-panel/admin.html';
  });

  document.querySelector('#transactions').addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = '/admin-panel/transactions.html';
  });
</script>

      
</body>
</html>