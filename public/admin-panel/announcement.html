<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Asset admin panel</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <link rel="stylesheet" href="./styles/admin-dashboard.css">
    <link rel="stylesheet" href="./styles/announcement.css">
</head>
<body>
    <button class="menu-btn" id="menuToggle">
        <ion-icon name="menu"></ion-icon>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="logo">
            <ion-icon name="rocket"></ion-icon>
           <a href="./admin.html">Global Assets</a> 
        </div>
        <div id="dashboard" class="nav-item">
            <ion-icon name="speedometer"></ion-icon>
           <a href="./admin.html">Dashboard</a> 
        </div>
        <div id="users" class="nav-item">
            <ion-icon name="people"></ion-icon>
          <a href="./user-management.html">Users</a>  
        </div>
        <div id="transaction" class="nav-item">
            <ion-icon name="cash"></ion-icon>
           <a href="./transactions.html">Transactions</a> 
        </div>
        <div id="kyc-review" class="nav-item">
            <ion-icon name="document"></ion-icon>
           <a href="./kyc-review.html">KYC Review</a> 
        </div>
        <div id="loan-review" class="nav-item">
            <ion-icon name="card"></ion-icon>
            <a href="./loan-review.html">Loan Requests</a>
        </div>
        <div id="settings" class="nav-item">
            <ion-icon name="settings"></ion-icon>
           <a href="./settings.html">Settings</a> 
        </div>
        <div id="announcement" class="nav-item active">
            <ion-icon name="megaphone"></ion-icon>
            <a href="./announcement.html">Publish Announcement</a>
        </div>
         <div id="announcement" class="nav-item">
            <ion-icon name="trending-up-outline"></ion-icon>
            <a href="./trades.html">Trades</a>
        </div>
         <div id="chats" class="nav-item">
             <ion-icon name="chatbubble"></ion-icon>
            <a href="./chat.html">Chats</a>
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <h1>Publish Announcement</h1>
            <p>Send important updates to all users</p>
        </div>
    
        <div class="announcement-card">
            <div class="card-header">
                <div class="header-icon">
                    <ion-icon name="megaphone" style="color: #8b5cf6;"></ion-icon>
                </div>
                <h2>Create New Announcement</h2>
            </div>
            
            <form id="announcement-form">
                <div class="form-group">
                    <label for="announcement-content">Message</label>
                    <textarea id="announcement-content" placeholder="Type your announcement here..." rows="6" required></textarea>
                </div>
                
                <div class="form-footer">
                    <button type="reset" class="btn-secondary">
                        <ion-icon name="trash"></ion-icon> Clear
                    </button>
                    <button type="submit" class="btn-primary">
                        <ion-icon name="paper-plane"></ion-icon> Publish
                    </button>
                </div>
            </form>
        </div>
    
        <!-- Recent Announcements Section -->
        <div class="section-title">
            <h2>Recent Announcements</h2>
            <p>Your previously published messages</p>
        </div>
        
        <div class="announcements-list">
            
            <div class="announcement-item">
                <div class="announcement-icon">
                    <ion-icon name="megaphone"></ion-icon>
                </div>
                <div class="announcement-content">
                    <p>We've launched the new dashboard analytics. Check out the improved reporting features under the Statistics tab.</p>
                    <!-- Default buttons -->
                    <div class="default-actions">
                        <button class="action-btn edit-btn">
                            <ion-icon name="create"></ion-icon> Edit
                        </button>
                        <button class="action-btn delete-btn">
                            <ion-icon name="trash"></ion-icon> Delete
                        </button>
                    </div>

                    <!-- Edit mode buttons (initially hidden) -->
                    <div class="edit-actions" style="display: none;">
                        <button class="action-btn cancel-btn">
                            <ion-icon name="close-circle"></ion-icon> Cancel
                        </button>
                        <button class="action-btn save-btn">
                            <ion-icon name="checkmark-circle"></ion-icon> Save
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <!-- Success Modal -->
    <div class="modal" id="success-modal">
        <div class="modal-content">
            <div class="modal-icon success">
                <ion-icon name="checkmark-circle"></ion-icon>
            </div>
            <h3>Announcement Published!</h3>
            <p>Your message has been successfully sent to all users.</p>
            <button class="modal-close">Continue</button>
        </div>
    </div>

    <script src="admin-common.js"></script>
   <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('announcement-form');
            const modal = document.getElementById('success-modal');
            const closeModal = document.querySelector('.modal-close');
            const textarea = document.getElementById('announcement-content');
        
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
            
                const message = textarea.value.trim();
                if (!message) {
                    alert('Please enter an announcement message.');
                    return;
                }
            
                try {
                    const response = await fetch('/api/v1/admin/sendAnnouncment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            notificationMessage: message
                        })
                    });
                
                    if (!response.ok) {
                        // Optionally, handle error response here
                        const errorData = await response.json();
                        alert(
                            errorData.message ||
                            'Failed to send announcement. Please try again.'
                        );
                        return;
                    }
                
                    // Show success modal
                    modal.style.display = 'flex';
                
                    // Reset form after submission
                    setTimeout(() => {
                        form.reset();
                    }, 1000);
                
                } catch (error) {
                    alert('An error occurred. Please try again.');
                    console.error(error);
                }
            });
        
            closeModal.addEventListener('click', function() {
                window.location.reload();
            });
        
            // Close modal when clicking outside content
            window.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>

  <script>
document.addEventListener('DOMContentLoaded', function () {
    const announcementsList = document.querySelector('.announcements-list');

    // Helper to show toast
    function showToast(message) {
        const toast = document.createElement('div');
        toast.textContent = message;
        toast.style.position = 'fixed';
        toast.style.bottom = '30px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = '#333';
        toast.style.color = '#fff';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '5px';
        toast.style.zIndex = 9999;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 2000);
    }

    // Helper to place caret at end
    function placeCaretAtEnd(el) {
        const range = document.createRange();
        const selection = window.getSelection();
        range.selectNodeContents(el);
        range.collapse(false);
        selection.removeAllRanges();
        selection.addRange(range);
    }

    // Helper to exit edit mode
    function exitEditMode(item) {
        const text = item.querySelector('.announcement-content p');
        const defaultActions = item.querySelector('.default-actions');
        const editActions = item.querySelector('.edit-actions');
        text.contentEditable = false;
        text.style.padding = '0rem';
        defaultActions.classList.remove('hidden');
        editActions.style.display = 'none';
    }

    // Render announcements
    async function loadAnnouncements() {
        announcementsList.innerHTML = '<p>Loading...</p>';
        try {
            const res = await fetch('/api/v1/admin/getAnnouncement');
            const data = await res.json();
            if (!data.success) throw new Error(data.message || 'Failed to load');
            if (!Array.isArray(data.data) || data.data.length === 0) {
                announcementsList.innerHTML = '<p>No announcements found.</p>';
                return;
            }
            announcementsList.innerHTML = '';
            data.data.forEach(announcement => {
                const item = document.createElement('div');
                item.className = 'announcement-item';
                item.dataset.id = announcement._id;
                item.innerHTML = `
                    <div class="announcement-icon">
                        <ion-icon name="megaphone"></ion-icon>
                    </div>
                    <div class="announcement-content">
                        <p>${escapeHtml(announcement.message)}</p>
                        <div class="default-actions">
                            <button class="action-btn edit-btn">
                                <ion-icon name="create"></ion-icon> Edit
                            </button>
                            <button class="action-btn delete-btn">
                                <ion-icon name="trash"></ion-icon> Delete
                            </button>
                        </div>
                        <div class="edit-actions" style="display: none;">
                            <button class="action-btn cancel-btn">
                                <ion-icon name="close-circle"></ion-icon> Cancel
                            </button>
                            <button class="action-btn save-btn">
                                <ion-icon name="checkmark-circle"></ion-icon> Save
                            </button>
                        </div>
                    </div>
                `;
                announcementsList.appendChild(item);
            });
            bindAnnouncementActions();
        } catch (err) {
            announcementsList.innerHTML = '<p style="color:red;">Failed to load announcements.</p>';
        }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Bind edit and delete actions
    function bindAnnouncementActions() {
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.onclick = function () {
                const item = this.closest('.announcement-item');
                const text = item.querySelector('.announcement-content p');
                const defaultActions = item.querySelector('.default-actions');
                const editActions = item.querySelector('.edit-actions');
                const originalText = text.textContent;

                text.contentEditable = true;
                text.style.padding = '1rem';
                defaultActions.classList.add('hidden');
                editActions.style.display = 'flex';
                editActions.style.gap = '1rem';

                setTimeout(() => {
                    text.focus();
                    placeCaretAtEnd(text);
                }, 10);

                // Cancel
                const cancelBtn = item.querySelector('.cancel-btn');
                cancelBtn.onclick = function () {
                    text.textContent = originalText;
                    exitEditMode(item);
                };

                // Save
                const saveBtn = item.querySelector('.save-btn');
                saveBtn.onclick = async function () {
                    const updatedMessage = text.textContent.trim();
                    if (!updatedMessage) {
                        showToast('Message cannot be empty.');
                        return;
                    }
                    const notificationId = item.dataset.id;
                    try {
                        const res = await fetch('/api/v1/admin/updateAnnouncement', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                notificationId,
                                updatedMessage
                            })
                        });
                        const result = await res.json();
                        if (!res.ok || result.statusCode !== 200) {
                            showToast(result.message || 'Failed to update.');
                            text.textContent = originalText;
                        } else {
                            showToast('Announcement updated successfully!');
                        }
                    } catch (err) {
                        showToast('Error updating announcement.');
                        text.textContent = originalText;
                    }
                    exitEditMode(item);
                };
            };
        });

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.onclick = async function () {
                const item = this.closest('.announcement-item');
                const notificationId = item.dataset.id;
                try {
                    const res = await fetch('/api/v1/admin/deleteAnnouncement', {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ notificationId })
                    });
                    const result = await res.json();
                    if (!res.ok || result.statusCode !== 200) {
                        showToast(result.message || 'Failed to delete.');
                    } else {
                        item.remove();
                        showToast('Announcement deleted.');
                    }
                } catch (err) {
                    showToast('Error deleting announcement.');
                }
            };
        });
    }

    // Initial load
    loadAnnouncements();
});
</script>
</body>
</html>