<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Asset admin panel</title>
    <link rel="stylesheet" href="./styles/repayment.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <link rel="stylesheet" href="./styles/admin-dashboard.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display:none;">
      <div class="spinner"></div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container"></div>

    <button class="menu-btn" id="menuToggle">
        <ion-icon name="menu"></ion-icon>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="logo">
            <ion-icon name="rocket"></ion-icon>
           <a href="./admin.html">Global Assets</a> 
        </div>
        <div id="dashboard" class="nav-item active">
            <ion-icon name="speedometer"></ion-icon>
           <a href="./admin.html">Dashboard</a> 
        </div>
        <div id="users" class="nav-item">
            <ion-icon name="people"></ion-icon>
          <a href="./user-management.html">Users</a>  
        </div>
        <div id="transaction" class="nav-item">
            <ion-icon name="cash"></ion-icon>
           <a href="./transactions.html">Transactions</a> 
        </div>
        <div id="kyc-review" class="nav-item">
            <ion-icon name="document"></ion-icon>
           <a href="./kyc-review.html">KYC Review</a> 
        </div>
        <div id="loan-review" class="nav-item">
            <ion-icon name="card"></ion-icon>
            <a href="./loan-review.html">Loan Requests</a>
        </div>
        <div id="settings" class="nav-item">
            <ion-icon name="settings"></ion-icon>
           <a href="./settings.html">Settings</a> 
        </div>
         <div id="announcement" class="nav-item">
            <ion-icon name="megaphone"></ion-icon>
            <a href="./announcement.html">Publish Announcement</a>
        </div>
         <div id="announcement" class="nav-item">
            <ion-icon name="trending-up-outline"></ion-icon>
            <a href="./trades.html">Trades</a>
        </div>
        <div id="chats" class="nav-item">
             <ion-icon name="chatbubble"></ion-icon>
            <a href="./chat.html">Chats</a>
        </div>
    </div>

     <div class="main-content">
        <div class="content-header">
            <div class="repayment-header">
                <h1>Repayment Requests</h1>
                <div class="filters">
                    <button class="filter-btn active" data-status="pending">
                        <i class="fas fa-hourglass-half"></i> Pending
                    </button>
                    <button class="filter-btn" data-status="approved">
                        <i class="fas fa-check-circle"></i> Approved
                    </button>
                    <button class="filter-btn" data-status="rejected">
                        <i class="fas fa-times-circle"></i> Rejected
                    </button>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="back-btn">
                    <i class="fas fa-arrow-left"></i> Back to Loans
                </button>
            </div>
        </div>

        <div class="admin-alert">
            <i class="fas fa-exclamation-circle alert-icon"></i>
            <div class="alert-content">
                <strong>Repayment Processing Notice:</strong> 
                Ensure repayment details match the transaction records before approval. 
                Once approved, funds will be credited to the user's account immediately.
            </div>
        </div>

        <div class="repayments-container">
            <!-- Repayment Card 1 -->
            <!-- <div class="repayment-card pending">
                <div class="user-info">
                    <div class="user-avatar">MJ</div>
                    <div class="user-details">
                        <div class="user-name">Michael Johnson</div>
                        <div class="user-status">
                            <span class="status-indicator pending"></span>
                            <span>Pending Approval</span>
                        </div>
                    </div>
                </div>
                
                <div class="repayment-details">
                    <div class="detail-group">
                        <div class="detail-label">Amount Due</div>
                        <div class="detail-value amount-due">$12,937.50</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Amount Paid</div>
                        <div class="detail-value amount-paid">$4,200.00</div>
                    </div>
                </div>
                
                <div class="controls-section">
                    <div class="date-container">
                        <div class="date-group">
                            <div class="date-label">
                                <i class="fas fa-calendar-check"></i>
                                Payment Date
                            </div>
                            <div class="date-value">Nov 10, 2023</div>
                        </div>
                        <div class="date-group">
                            <div class="date-label">
                                <i class="fas fa-calendar-times"></i>
                                Due Date
                            </div>
                            <div class="date-value due-soon">Nov 15, 2023</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="approve-btn">
                            <i class="fas fa-check-circle"></i> Approve
                        </button>
                        <button class="reject-btn">
                            <i class="fas fa-times-circle"></i> Reject
                        </button>
                    </div>
                </div>
            </div> -->
            
            <!-- Repayment Card 2 -->
            <!-- <div class="repayment-card pending">
                <div class="user-info">
                    <div class="user-avatar">SD</div>
                    <div class="user-details">
                        <div class="user-name">Sarah Davis</div>
                        <div class="user-status">
                            <span class="status-indicator pending"></span>
                            <span>Pending Approval</span>
                        </div>
                    </div>
                </div>
                
                <div class="repayment-details">
                    <div class="detail-group">
                        <div class="detail-label">Amount Due</div>
                        <div class="detail-value amount-due">€8,389.00</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Amount Paid</div>
                        <div class="detail-value amount-paid">€1,500.00</div>
                    </div>
                </div>
                
                <div class="controls-section">
                    <div class="date-container">
                        <div class="date-group">
                            <div class="date-label">
                                <i class="fas fa-calendar-check"></i>
                                Payment Date
                            </div>
                            <div class="date-value">Nov 10, 2023</div>
                        </div>
                        <div class="date-group">
                            <div class="date-label">
                                <i class="fas fa-calendar-times"></i>
                                Due Date
                            </div>
                            <div class="date-value">Dec 5, 2023</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="approve-btn">
                            <i class="fas fa-check-circle"></i> Approve
                        </button>
                        <button class="reject-btn">
                            <i class="fas fa-times-circle"></i> Reject
                        </button>
                    </div>
                </div>
            </div> -->
            
            <!-- Repayment Card 3 -->
            <!-- <div class="repayment-card approved">
                <div class="user-info">
                    <div class="user-avatar">TR</div>
                    <div class="user-details">
                        <div class="user-name">Thomas Rivera</div>
                        <div class="user-status">
                            <span class="status-indicator approved"></span>
                            <span>Approved</span>
                        </div>
                    </div>
                </div>
                
                <div class="repayment-details">
                    <div class="detail-group">
                        <div class="detail-label">Amount Due</div>
                        <div class="detail-value amount-due">$5,625.00</div>
                    </div>
                    <div class="detail-group">
                        <div class="detail-label">Amount Paid</div>
                        <div class="detail-value amount-paid">$700.00</div>
                    </div>
                </div>
                
                <div class="controls-section">
                    <div class="date-container">
                        <div class="date-group">
                            <div class="date-label">
                                <i class="fas fa-calendar-check"></i>
                                Payment Date
                            </div>
                            <div class="date-value">Sep 22, 2023</div>
                        </div>
                        <div class="date-group">
                            <div class="date-label">
                                <i class="fas fa-calendar-times"></i>
                                Due Date
                            </div>
                            <div class="date-value overdue">Oct 25, 2023</div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="approve-btn">
                            <i class="fas fa-check-circle"></i> Approve
                        </button>
                        <button class="reject-btn">
                            <i class="fas fa-times-circle"></i> Reject
                        </button>
                    </div>
                </div>
            </div> -->
        </div>

        <div class="pagination">
            <button class="pagination-btn">
                <i class="fas fa-chevron-left"></i>
            </button>
            <span class="active">1</span>
            <span>2</span>
            <span>3</span>
            <button class="pagination-btn">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>


    <script src="admin-common.js"></script>


    <script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.querySelector('.repayments-container');
  const filterButtons = document.querySelectorAll('.filter-btn');
  const paginationContainer = document.querySelector('.pagination');
  const loadingOverlay = document.getElementById('loading-overlay');
  const toastContainer = document.getElementById('toast-container');
  const ITEMS_PER_PAGE = 5;

  let currentPage = 1;
  let currentStatus = 'Pending';

  const showLoading = () => loadingOverlay.style.display = 'flex';
  const hideLoading = () => loadingOverlay.style.display = 'none';

  const showToast = (message, type = 'success') => {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    toastContainer.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  };

  const fetchAndRender = async () => {
    showLoading();
    try {
      const res = await fetch(`/api/v1/admin/repaymentRequests?page=${currentPage}&limit=${ITEMS_PER_PAGE}&status=${currentStatus}`);
      const data = await res.json();
      if (!data.success) throw new Error('Failed to fetch');
      renderRepayments(data.data.requests);
      renderPagination(data.data.page, data.data.lastPage);
    } catch (err) {
      container.innerHTML = `<div class="error">Error loading data</div>`;
      showToast("Something went wrong while loading.", 'error');
    } finally {
      hideLoading();
    }
  };

  const renderRepayments = (requests) => {
    container.innerHTML = '';
    if (!requests.length) {
      container.innerHTML = '<p>No repayment requests found.</p>';
      return;
    }

    requests.forEach(req => {
      const dueDate = new Date(req.loanDetails.dueDate).toLocaleDateString();
      const paymentDate = new Date(req.requestDate).toLocaleDateString();
      const statusClass = req.status.toLowerCase();

      const card = document.createElement('div');
      card.className = `repayment-card ${statusClass}`;
      card.innerHTML = `
        <div class="user-info">
          <div class="user-avatar">${getInitials(req.userName)}</div>
          <div class="user-details">
            <div class="user-name">${req.userName}</div>
            <div class="user-status">
              <span class="status-indicator ${statusClass}"></span>
              <span>${req.status}</span>
            </div>
          </div>
        </div>

        <div class="repayment-details">
          <div class="detail-group">
            <div class="detail-label">Amount Due</div>
            <div class="detail-value amount-due">${formatCurrency(req.loanDetails.loanAmount)}</div>
          </div>
          <div class="detail-group">
            <div class="detail-label">Amount Paid</div>
            <div class="detail-value amount-paid">${formatCurrency(req.requestedAmount)}</div>
          </div>
        </div>

        <div class="controls-section">
          <div class="date-container">
            <div class="date-group">
              <div class="date-label"><i class="fas fa-calendar-check"></i> Payment Date</div>
              <div class="date-value">${paymentDate}</div>
            </div>
            <div class="date-group">
              <div class="date-label"><i class="fas fa-calendar-times"></i> Due Date</div>
              <div class="date-value">${dueDate}</div>
            </div>
          </div>
          <div class="action-buttons">
            ${req.status === 'Pending' ? `
              <button class="approve-btn" data-id="${req._id}"><i class="fas fa-check-circle"></i> Approve</button>
              <button class="reject-btn" data-id="${req._id}"><i class="fas fa-times-circle"></i> Reject</button>
            ` : ''}
          </div>
        </div>
      `;
      container.appendChild(card);
    });

    bindApproveRejectEvents();
  };

  const bindApproveRejectEvents = () => {
    document.querySelectorAll('.approve-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        showLoading();
        try {
          const res = await fetch('/api/v1/admin/approveRepaymentRequest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ repaymentRequestId: id })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || 'Approval failed');
          showToast('Repayment approved successfully.');
          fetchAndRender();
        } catch (err) {
          showToast(err.message || 'Approval failed', 'error');
        } finally {
          hideLoading();
        }
      });
    });

    document.querySelectorAll('.reject-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-id');
        showLoading();
        try {
          const res = await fetch('/api/v1/admin/rejectRepaymentRequest', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ repaymentRequestId: id, adminNotes: 'Rejected by admin' })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.message || 'Rejection failed');
          showToast('Repayment rejected successfully.');
          fetchAndRender();
        } catch (err) {
          showToast(err.message || 'Rejection failed', 'error');
        } finally {
          hideLoading();
        }
      });
    });
  };

  const renderPagination = (page, lastPage) => {
    paginationContainer.innerHTML = '';

    const createPageBtn = (pageNum, isActive = false) => {
      const span = document.createElement('span');
      span.textContent = pageNum;
      if (isActive) span.classList.add('active');
      span.addEventListener('click', () => {
        currentPage = pageNum;
        fetchAndRender();
      });
      return span;
    };

    if (page > 1) {
      const prevBtn = document.createElement('button');
      prevBtn.classList.add('pagination-btn');
      prevBtn.innerHTML = `<i class="fas fa-chevron-left"></i>`;
      prevBtn.addEventListener('click', () => {
        currentPage--;
        fetchAndRender();
      });
      paginationContainer.appendChild(prevBtn);
    }

    for (let i = 1; i <= lastPage; i++) {
      paginationContainer.appendChild(createPageBtn(i, i === page));
    }

    if (page < lastPage) {
      const nextBtn = document.createElement('button');
      nextBtn.classList.add('pagination-btn');
      nextBtn.innerHTML = `<i class="fas fa-chevron-right"></i>`;
      nextBtn.addEventListener('click', () => {
        currentPage++;
        fetchAndRender();
      });
      paginationContainer.appendChild(nextBtn);
    }
  };

  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentStatus = btn.getAttribute('data-status');
      currentPage = 1;
      fetchAndRender();
    });
  });

  const getInitials = name => name.split(' ').map(n => n[0]).join('').toUpperCase();

  const formatCurrency = amount => {
    if (typeof amount !== 'number') return amount;
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
  };

  // Initial load
  fetchAndRender();
});
</script>

    </body>
</html>