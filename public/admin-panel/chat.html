<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chats - global assets</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <link rel="stylesheet" href="./styles/admin-dashboard.css">
    <link rel="stylesheet" href="./styles/chat.css">
</head>
<body>
    <button class="menu-btn" id="menuToggle">
        <ion-icon name="menu"></ion-icon>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="logo">
            <ion-icon name="rocket"></ion-icon>
           <a href="./admin.html">Global Assets</a> 
        </div>
        <div id="dashboard" class="nav-item">
            <ion-icon name="speedometer"></ion-icon>
           <a href="./admin.html">Dashboard</a> 
        </div>
        <div id="users" class="nav-item">
            <ion-icon name="people"></ion-icon>
          <a href="./user-management.html">Users</a>  
        </div>
        <div id="transaction" class="nav-item">
            <ion-icon name="cash"></ion-icon>
           <a href="./transactions.html">Transactions</a> 
        </div>
        <div id="kyc-review" class="nav-item">
            <ion-icon name="document"></ion-icon>
           <a href="./kyc-review.html">KYC Review</a> 
        </div>
        <div id="loan-review" class="nav-item">
            <ion-icon name="card"></ion-icon>
            <a href="./loan-review.html">Loan Requests</a>
        </div>
        <div id="settings" class="nav-item">
            <ion-icon name="settings"></ion-icon>
           <a href="./settings.html">Settings</a> 
        </div>
         <div id="announcement" class="nav-item">
            <ion-icon name="megaphone"></ion-icon>
            <a href="./announcement.html">Publish Announcement</a>
        </div>
         <div id="announcement" class="nav-item">
            <ion-icon name="trending-up-outline"></ion-icon>
            <a href="./trades.html">Trades</a>
        </div>
        <div id="chats" class="nav-item active">
             <ion-icon name="chatbubble"></ion-icon>
            <a href="./chat.html">Chats</a>
        </div>
    </div>

    <div class="main-content">
        <div class="admin-chat-container">
        <div class="chat-header">
            <h1>
                <ion-icon name="chatbubbles"></ion-icon>
                User Chat Management
            </h1>
            <div class="admin-status-control">
                <div class="status-label">My Chat Status:</div>
                <div class="status-options">
                    <div class="status-option active">Auto</div>
                    <div class="status-option">Online</div>
                    <div class="status-option">Offline</div>
                </div>
            </div>
        </div>
        
        <div class="chat-container">
            <!-- Left Column: User List -->
            <div class="user-list-container">
                <div class="user-list-header">
                    <div class="search-container">
                        <ion-icon name="search"></ion-icon>
                        <input type="text" placeholder="Search users...">
                    </div>
                </div>
                <div class="user-list">
                   
                </div>
            </div>
            
            <!-- Right Column: Chat Area -->
            <div class="chat-modal">
                <div class="chat-modal-header">
                    <div class="chat-user-info">
                        <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User" class="user-avatar">
                        <div>
                            <h3>Loading</h3>
                            <div class="modal-status">
                                <span class="status-dot status-online"></span>
                                Loading..
                            </div>
                        </div>
                    </div>
                    <button class="close-modal">
                        <ion-icon name="close"></ion-icon>
                    </button>
                </div>
                
                <div class="chat-history">
                    <!-- Previous messages -->
                    <div class="message-group">
                        <div class="message admin-message">
                           Loading..
                            <div class="message-time">Loading..</div>
                        </div>
                        
                       
                    </div>
                    
                    <!-- Unread messages divider -->
                    <div class="unread-divider">
                        <div class="divider-line"></div>
                        <div class="divider-text">NEW MESSAGES</div>
                        <div class="divider-line"></div>
                    </div>
                    
                    <!-- Unread messages -->
                    <div class="message-group">
                        <div class="message user-message">
                            Loading..
                            <div class="message-time">Loading..</div>
                        </div>
                        
                    </div>
                </div>
                
                <div class="message-input-area">
                    <textarea class="message-input" placeholder="Type your message..." rows="1"></textarea>
                    <button class="send-btn">
                        <ion-icon name="send"></ion-icon>
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>
    <script>
  ;(() => {
    // --- DOM references ---
    const userListEl       = document.querySelector('.user-list');
    const statusOptions    = document.querySelectorAll('.status-option');
    const chatModal        = document.querySelector('.chat-modal');
    const chatHistoryEl    = chatModal.querySelector('.chat-history');
    const headerAvatar     = chatModal.querySelector('.chat-user-info .user-avatar');
    const headerName       = chatModal.querySelector('.chat-user-info h3');
    const headerStatusDot  = chatModal.querySelector('.chat-user-info .status-dot');
    const headerStatusText = chatModal.querySelector('.chat-user-info .modal-status');
    const closeModalBtn    = chatModal.querySelector('.close-modal');
    const messageInput     = chatModal.querySelector('.message-input');
    const sendBtn          = chatModal.querySelector('.send-btn');
  const API_BASE = `https://${window.location.hostname}/api/v1/chats`;
  const WS_URL = `wss://${window.location.hostname}/ws/chat`;



    let socket, selectedUserId = null, adminUserId = null;
    let didAutoSelectFirst = false;
    let page          = 0;
    const pageSize    = 8;
    let loadingUsers  = false;
    let allUsersLoaded = false;
    let chatPage           = 0;
    const chatPageSize     = 10;
    let loadingHistory     = false;
    let allHistoryLoaded   = false;




    // --- WebSocket Setup ---
function connectWebSocket() {
  console.log('[Admin Chat] Connecting to WS…');
  socket = new WebSocket(WS_URL);

  socket.onopen = () => {
    const token = localStorage.getItem('accessToken');
    console.log('[Admin Chat] WS open, authenticating as admin');
    socket.send(JSON.stringify({ type: 'auth', token }));
  };

  socket.onmessage = async ({ data }) => {
    const msg = JSON.parse(data);
    console.log('[Admin Chat] WS message:', msg);

    switch (msg.type) {
      case 'authSuccess':
        adminUserId = msg.userId;
        console.log('[Admin Chat] Authenticated as admin:', adminUserId);
        await fetchUserList();
        break;

      case 'userStatusUpdate': {
        const { userId, isOnline } = msg;
        updateUserStatusDot(userId, isOnline);

        if (userId === selectedUserId) {
          updateHeaderStatus(isOnline);
        }
        break;
      }

     case 'newChatMessage': {
        const chatMsg = msg.message;
        if (!chatMsg) return;

        const senderId = chatMsg.senderId && chatMsg.senderId._id
          ? chatMsg.senderId._id
          : chatMsg.senderId;

        if (selectedUserId && senderId === selectedUserId) {
          renderAdminChatMessage(chatMsg);
          await markMessagesAsRead(senderId);
        }
        else {
          const userItem = itemById(senderId);
          if (userItem) {
            let unreadEl = userItem.querySelector('.unread-count');
            if (!unreadEl) {
              unreadEl = document.createElement('div');
              unreadEl.className = 'unread-count';
              userItem.appendChild(unreadEl);
            }
            const currentCount = parseInt(unreadEl.textContent) || 0;
            unreadEl.textContent = String(currentCount + 1);
          }
        }
        break;
      }



      case 'error':
        console.error('[Admin Chat] WS error:', msg.message);
        break;
    }
  };

  socket.onclose = () => {
    console.warn('[Admin Chat] WS closed, retry in 5s');
    setTimeout(connectWebSocket, 5000);
  };

  socket.onerror = (err) => {
    console.error('[Admin Chat] WS error:', err);
    socket.close();
  };
}

    // --- REST: Fetch & render user list ---
   async function fetchUserList() {
  if (loadingUsers) return;
  loadingUsers = true;

  userListEl.innerHTML = '';
  for (let i = 0; i < pageSize; i++) {
    const sk = document.createElement('div');
    sk.className = 'user-item skeleton';
    userListEl.append(sk);
  }

  try {
    const res = await fetch(
      `${API_BASE}/admin/users-for-chat-list?page=${page}&limit=${pageSize}`,
      { headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` } }
    );
    const { data } = await res.json();

    userListEl.innerHTML = '';
    data.forEach(renderUserItem);

    if (data.length < pageSize) {
      allUsersLoaded = true;
    } else {
      page++;
    }

    if (!didAutoSelectFirst && data.length > 0) {
      didAutoSelectFirst = true;
      selectUser(data[0]);
    }

  } catch (err) {
    console.error('[Admin Chat] Failed to load users:', err);
  } finally {
    
    loadingUsers = false;
  }
}


  function renderUserItem(user) {
  const { _id, email, dpLocalPath, actualOnlineStatus, unreadMessageCount } = user;

  let avatarSrc;
  if (dpLocalPath) {
    const p = dpLocalPath.replace(/^public[\\/]/, '').replace(/\\/g, '/');
    avatarSrc = `/${p}`;
  } else {
    avatarSrc = '../Images/default-profilepic.png';
  }

  const item = document.createElement('div');
  item.className = 'user-item';
  item.dataset.userId = _id;

  const unreadDiv = unreadMessageCount > 0
  ? `<div class="unread-count">${unreadMessageCount}</div>`
  : '';


  item.innerHTML = `
    <div class="user-avatar-container">
      <img src="${avatarSrc}" alt="" class="user-avatar">
      <div class="status-indicator status-${actualOnlineStatus ? 'online pulse' : 'offline'}"></div>
    </div>
    <div class="user-info">
      <div class="user-name">${email}</div>
    </div>
    ${unreadDiv}
  `;

  item.addEventListener('click', () => selectUser(user));

  userListEl.append(item);
}


   async function selectUser(user) {
  chatPage         = 0;
  allHistoryLoaded = false;
  chatHistoryEl.innerHTML = '';
  for (let i = 0; i < chatPageSize; i++) {
    const sk = document.createElement('div');
    sk.className = 'message skeleton';
    chatHistoryEl.append(sk);
  }
  scrollHistoryToBottom();

  selectedUserId = user._id;

  document.querySelectorAll('.user-item').forEach(el =>
    el.classList.toggle('active', el.dataset.userId === user._id)
  );

  const badgeEl = itemById(user._id).querySelector('.unread-count');
  if (badgeEl) badgeEl.remove();

  let avatarSrc;
  if (user.dpLocalPath) {
    const normalized = user.dpLocalPath
      .replace(/^public[\\/]/, '')   
      .replace(/\\/g, '/');        
    avatarSrc = `/${normalized}`;
  } else {
    avatarSrc = 'https://via.placeholder.com/40';
  }

  headerAvatar.src = avatarSrc;
  headerName.textContent = user.email;
  updateHeaderStatus(user.actualOnlineStatus);
  chatModal.classList.add('active');

  await fetchAdminChatHistory(user._id);
  await markMessagesAsRead(user._id);
}



    function itemById(id) {
      return userListEl.querySelector(`.user-item[data-user-id="${id}"]`);
    }

    function updateUserStatusDot(userId, isOnline) {
      const el = itemById(userId);
      if (!el) return;
      el.querySelector('.status-indicator').className =
        `status-indicator status-${isOnline ? 'online pulse' : 'offline'}`;
      el.querySelector('.modal-status .status-dot').className =
        `status-dot status-${isOnline ? 'online' : 'offline'}`;
      el.querySelector('.modal-status').childNodes[1].textContent = isOnline ? 'Online' : 'Offline';
    }

    function updateHeaderStatus(isOnline) {
      headerStatusDot.className = `status-dot status-${isOnline ? 'online' : 'offline'}`;
      headerStatusText.textContent = isOnline ? 'Online - Active now' : 'Offline';
    }

    async function fetchAdminChatHistory(otherUserId) {
  if (loadingHistory || allHistoryLoaded) return;
  loadingHistory = true;

  const url = `${API_BASE}/history/${otherUserId}?page=${chatPage}&limit=${chatPageSize}`;
  try {
    if (chatPage > 0) {
      for (let i = 0; i < 3; i++) {  
        const sk = document.createElement('div');
        sk.className = 'message skeleton';
        chatHistoryEl.prepend(sk);
      }
    }

    const res = await fetch(url, {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('accessToken')}` }
    });
    const { data } = await res.json();

    chatHistoryEl.querySelectorAll('.message.skeleton').forEach(el => el.remove());

    if (chatPage === 0) {
      data.forEach(renderAdminChatMessage);
      scrollHistoryToBottom();
    } else {
  const prevScrollHeight = chatHistoryEl.scrollHeight;

  chatHistoryEl.querySelectorAll('.message.skeleton').forEach(el => el.remove());

  data.forEach(msg => {
    const senderId = msg.senderId && msg.senderId._id
      ? msg.senderId._id
      : msg.senderId;
    const isAdminMsg = senderId === adminUserId;

    const el = document.createElement('div');
    el.classList.add('message', isAdminMsg ? 'admin-message' : 'user-message');
    const time = new Date(msg.createdAt)
      .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    el.innerHTML = `
      ${msg.messageContent}
      <div class="message-time">${time}</div>
    `;

    chatHistoryEl.insertBefore(el, chatHistoryEl.firstChild);
  });

  const newScrollHeight = chatHistoryEl.scrollHeight;
  chatHistoryEl.scrollTop = newScrollHeight - prevScrollHeight;
}


    if (data.length > 0) chatPage++;
    if (data.length < chatPageSize) allHistoryLoaded = true;


  } catch (err) {
    console.error('[Admin Chat] Failed to fetch history:', err);
  } finally {
    loadingHistory = false;
  }
}


   async function markMessagesAsRead(otherUserId) {
  if (!otherUserId) return;
  try {
    await fetch(`${API_BASE}/chat/markMessagesAsRead`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
      },
      body: JSON.stringify({ otherUserId })
    });

    
    const userItem = itemById(otherUserId);
    if (userItem) {
      const badge = userItem.querySelector('.unread-count');
      if (badge) badge.remove();
    }

    console.log('[Admin Chat] markMessagesAsRead for', otherUserId);
  } catch (err) {
    console.error('[Admin Chat] markMessagesAsRead error:', err);
  }
}


  function renderAdminChatMessage(msg) {
        const senderId = msg.senderId && msg.senderId._id
            ? msg.senderId._id
            : msg.senderId;
    
        const isSenderAdmin = (typeof msg.senderId === 'string' && msg.senderId === adminUserId) || (msg.senderId && msg.senderId.isAdmin);
    
        const el = document.createElement('div');
        el.classList.add('message');
    
        if (isSenderAdmin) {
            el.classList.add('admin-message');
        } else {
            el.classList.add('user-message');
        }
    
        const time = new Date(msg.createdAt)
            .toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
        el.innerHTML = `
            ${msg.messageContent}
            <div class="message-time">${time}</div>
        `;
        
        chatHistoryEl.append(el);
        scrollHistoryToBottom();
    }

    function scrollHistoryToBottom() {
      chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
    }

    function bumpUserBadge(userId) {
      const badge = itemById(userId).querySelector('.unread-count');
      const current = parseInt(badge.textContent) || 0;
      badge.textContent = current + 1;
    }

    
    sendBtn.addEventListener('click', adminSendMessage);
    messageInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        adminSendMessage();
      }
    });

    async function adminSendMessage() {
      const text = messageInput.value.trim();
      if (!text || !selectedUserId) return;

      
      renderAdminChatMessage({
        senderId: adminUserId,
        messageContent: text,
        createdAt: new Date()
      });
      messageInput.value = '';
      messageInput.style.height = 'auto';

      try {
        const res = await fetch(`${API_BASE}/chat/send`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
          },
          body: JSON.stringify({
            receiverId: selectedUserId,
            messageContent: text
          })
        });
        if (!res.ok) {
          console.error('[Admin Chat] send failed', await res.json());
        } else {
          console.log('[Admin Chat] sent to', selectedUserId);
        }
      } catch (err) {
        console.error('[Admin Chat] send error', err);
      }
    }

    
    closeModalBtn.addEventListener('click', () => {
      chatModal.classList.remove('active');
      selectedUserId = null;
      document.querySelectorAll('.user-item').forEach(i => i.classList.remove('active'));
    });

    
    statusOptions.forEach(opt => {
      opt.addEventListener('click', async () => {
        statusOptions.forEach(o => o.classList.remove('active'));
        opt.classList.add('active');
        const status = opt.textContent.trim(); 
        console.log('[Admin Chat] Setting status →', status);
        try {
          const res = await fetch(`${API_BASE}/admin/set-display-status`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
            },
            body: JSON.stringify({ status })
          });
          console.log('[Admin Chat] set-display-status response:', await res.json());
        } catch (err) {
          console.error('[Admin Chat] status update error:', err);
        }
      });
    });

    window.addEventListener('load', () => {
      connectWebSocket();
      userListEl.addEventListener('scroll', () => {
        if (loadingUsers || allUsersLoaded) return;
        const { scrollTop, clientHeight, scrollHeight } = userListEl;
        if (scrollTop + clientHeight >= scrollHeight - 10) {
          fetchUserList();
        }
      });
      chatHistoryEl.addEventListener('scroll', () => {
        if (chatHistoryEl.scrollTop <= 10 && !loadingHistory && !allHistoryLoaded) {
          fetchAdminChatHistory(selectedUserId);
        }
      });


    });
  })();
</script>


    <script src="admin-common.js"></script>  
</body>
</html>