<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market - Global Assets</title>
    
    <link rel="stylesheet" href="./css/homepage.css">
    
    <link rel="stylesheet" href="./css/profile.css">
    <link rel="icon" type="image/x-icon" href="./Images/favicon.ico">
    <link rel="stylesheet" href="./css/chart-page.css">

</head>
<body>
<header id="header">
    <div class="header-container">
        <div class="nav-menu">
            <div class="logo-container">
               <a href="./"> <img src="./Images/home_logo.png" alt="Company Logo"> </a>
            </div>
            <nav class="desktop-nav">
                <a href="./" class="nav-item">Home</a>
                <a href="./market.html" class="nav-item">Market</a>
                <a href="./ai-finance.html" class="nav-item">AI Finance</a>
                <a href="./loan.html" class="nav-item">Loans</a>
                <a href="./profile.html" class="nav-item">Account</a>
            </nav>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn sign-up-btn">Sign Up</button>
            <button id="nav-black-btn" class="nav-btn sign-in-btn">Sign In</button>
        </div>

        <button class="mobile-menu-toggle">
            <div class="hamburger">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </button>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
         <a href="./" class="nav-item">Home</a>
         <a href="./market.html" class="nav-item">Market</a>
         <a href="./ai-finance.html" class="nav-item">AI Finance</a>
         <a href="./loan.html" class="nav-item">Loans</a>
         <a href="./profile.html" class="nav-item">Account</a>
        <div class="nav-buttons">
            <button class="nav-btn sign-up-btn">  Sign Up</button>
            <button id="nav-black-btn" class="nav-btn sign-in-btn">Sign In</button>
        </div>
    </nav>
  </header>

    <div class="chart-container">
                <!-- Chart Box -->
                <div class="chart-box">
           
                    <div class="chart-controls">
                <div class="interval-selector">
                    <button class="interval-btn" data-interval="1min">1 min</button>
                    <button class="interval-btn" data-interval="5min">5 min</button>
                    <button class="interval-btn" data-interval="15min">15 min</button>
                    <button class="interval-btn" data-interval="30min">30 min</button>
                    <button class="interval-btn active" data-interval="1day">1 day</button>
                    <button class="interval-btn" data-interval="1week">1 week</button>
                    <button id="resetZoom" class="reset-zoom-btn">Reset Zoom</button>
                </div>
            </div>
        
            <!-- Asset Header -->
            <div class="asset-header">
                <h1 class="asset-name">Loading...</h1>
                <div class="price-details">
                    <span class="current-price">...</span>
                    <span class="percentage-change positive">...</span>
                    <div class="ohlc-details">
                        <span>O: ....</span>
                        <span>H: ....</span>
                        <span>L: ....</span>
                        <span>C: ....</span>
                    </div>
                </div>
            </div>
        
            <!-- Chart Canvas -->
            <div class="chart-view active" id="chartView">
                <canvas id="priceChart"></canvas>
            </div>
        
            <!-- Order Book (Stub) -->
            <div class="orderbook-view" id="orderbookView">
                <div class="orderbook-side">
                    <h3>Bids</h3>
                    <div class="orderbook-list bids"></div>
                </div>
                <div class="orderbook-side">
                    <h3>Asks</h3>
                    <div class="orderbook-list asks"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- buttons controller -->
     <div class="trading-options">
        <button class="buy-btn">Buy</button>
        <button class="sell-btn">Sell</button>
     </div>

     <div class="profile-main">
      <div class="tabs-container">
  <div class="tabs-header">
    <button class="tab-btn active" data-tab-target="contracts">Contracts</button>
    <button class="tab-btn" data-tab-target="options">Options</button>
  </div>

  <!-- Contracts Tab -->
  <div class="tab-content active" id="contracts">
    <div class="transaction-cards">
     
    </div>
  </div>

  <!-- Options Tab -->
  <div class="tab-content" id="options">
    <div class="transaction-cards">
     
    </div>
  </div>
</div>
     </div>

      <footer class="footer">
    <div class="footer-content">
      <!-- Logo / Brand -->
      <div class="footer-section logo-section">
        <img src="./Images/logo_foot.png" alt="Global Assets Logo" class="footer-logo">
      </div>
      <!-- Company -->
      <div class="footer-section">
        <h4>Company</h4>
        <ul>
          <li><a href="./about.html">About Us</a></li>
          <li><a href="./team.html">About the Team</a></li>
          <li><a href="./faq.html">Help Center</a></li>
          <li><a href="#">Email support</a></li>
          <li><a href="mailto:service@global-assets.com">service@global‑assets.io</a></li>
        </ul>
      </div>
      <!-- Product -->
      <div class="footer-section">
        <h4>Product</h4>
        <ul>
          <li><a href="./market.html">Market List</a></li>
          <li><a href="./loan.html">Investment loans</a></li>
          <li><a href="./ai-finance.html">AI Finance</a></li>
        </ul>
      </div>
      <!-- Policy -->
      <div class="footer-section">
        <h4>Policy</h4>
        <ul>
          <li><a href="./agrt.html">User Services Agreement</a></li>
          <li><a href="./loan-agrt.html">Loan agreement</a></li>
          <li><a href="./loan-explain.html">Loan rules explanation</a></li>
          <li><a href="./legal-liability.html">Legal liability</a></li>
        </ul>
      </div>
      <!-- Statement -->
      <div class="footer-section">
        <h4>Statement</h4>
        <ul>
          <li><a href="./risk.html">Risk Warning</a></li>
          <li><a href="./privacy-statement.html">Privacy Statement</a></li>
          <li><a href="./anti-laundaring.html">Anti‑Money Laundering Policy</a></li>
          <li><a href="./rglt-licence.html">Regulatory license</a></li>
        </ul>
      </div>
    </div>
    <div class="footer-bottom">
      &copy; Copyright 2016 – 2025 Global Assets. All rights reserved.
    </div>
  </footer>
     
    <script src="./javascript/common-script.js"></script>
    <script src="./javascript/loing-check.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/date-fns/cdn.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<script>
let currentSymbol = 'AAPL';
let currentType = 'stock';
let currentInterval = '1day';
let currentOutputSize = '400';
let assetChartInstance = null;

const intervalMap = {
  '1min': { unit: 'minute', parser: 'yyyy-MM-dd HH:mm:ss', displayFormats: { minute: 'HH:mm' }, tooltipFormat: 'MMM dd, HH:mm' },
  '5min': { unit: 'minute', parser: 'yyyy-MM-dd HH:mm:ss', displayFormats: { minute: 'HH:mm' }, tooltipFormat: 'MMM dd, HH:mm' },
  '15min': { unit: 'minute', parser: 'yyyy-MM-dd HH:mm:ss', displayFormats: { minute: 'HH:mm' }, tooltipFormat: 'MMM dd, HH:mm' },
  '30min': { unit: 'hour', parser: 'yyyy-MM-dd HH:mm:ss', displayFormats: { hour: 'HH:mm' }, tooltipFormat: 'MMM dd, HH:mm' },
  '1hour': { unit: 'hour', parser: 'yyyy-MM-dd HH:mm:ss', displayFormats: { hour: 'HH:mm' }, tooltipFormat: 'MMM dd, HH:mm' },
  '1day': { unit: 'day', parser: 'yyyy-MM-dd', displayFormats: { day: 'MMM d,PPPP' }, tooltipFormat: 'MMM dd,PPPP' },
  '1week': { unit: 'week', parser: 'yyyy-MM-dd', displayFormats: { week: 'MMM d,PPPP' }, tooltipFormat: 'MMM dd,PPPP' },
  '1month': { unit: 'month', parser: 'yyyy-MM-dd', displayFormats: { month: 'MMM,yyyy' }, tooltipFormat: 'MMM,yyyy' },
};

async function fetchAndDisplayAssetDetails(symbol, type, interval, outputsize) {
  console.log(`Workspaceing data for ${symbol} (${type}) at ${interval} interval with outputsize=${outputsize}.`);

  const apiUrl = `/api/v1/market/get-asset-details?symbol=${encodeURIComponent(symbol)}&type=${encodeURIComponent(type)}&interval=${encodeURIComponent(interval)}&outputsize=${encodeURIComponent(outputsize)}&cb=${Date.now()}`;

  let payload;
  const chartBoxElement = document.querySelector('.chart-box');
  const priceChartCanvas = document.getElementById('priceChart');
  const chartContainerParent = priceChartCanvas ? priceChartCanvas.parentNode : null;

   if (chartBoxElement) {
        chartBoxElement.style.display = '';
        chartBoxElement.style.minHeight = '';
        chartBoxElement.style.alignItems = '';
        chartBoxElement.style.justifyContent = '';
        chartBoxElement.style.flexDirection = '';
        const errorMessageEl = chartBoxElement.querySelector('p[style*="color: red"]');
        if (errorMessageEl) {
            errorMessageEl.remove();
        }
    }
     if (priceChartCanvas) {
        priceChartCanvas.style.display = 'block';
        const messageEl = chartContainerParent ? chartContainerParent.querySelector('.chart-message') : null;
        if (messageEl) {
            messageEl.remove();
        }
    }

  try {
    console.log(`Workspaceing data from: ${apiUrl}`);
    const res = await fetch(apiUrl, { cache: 'no-store' });

    if (!res.ok) {
        const errorBody = await res.text();
        console.error(`HTTP error ${res.status}: ${res.statusText}`, errorBody);
        throw new Error(`HTTP Error ${res.status}: ${res.statusText}`);
    }

    payload = await res.json();
    console.log('API Response Payload:', payload);

    if (!payload || typeof payload.statusCode === 'undefined' || !payload.data) {
         console.error('API response payload is missing expected fields (statusCode or data):', payload);
         const backendMessage = payload && payload.message ? payload.message : 'Response missing critical top-level fields.';
         throw new Error(`API Payload Error: ${backendMessage}`);
    }

    if (payload.statusCode !== 200) {
        console.error('API response statusCode indicates error:', payload);
        const backendMessage = payload.message || `API returned status code ${payload.statusCode}.`;
        throw new Error(`API Status Error: ${backendMessage}`);
    }

    if (!payload.data.summary || !Array.isArray(payload.data.history)) {
         console.error('API payload data field is missing summary or history array or history is not array:', payload.data);
         const backendMessage = payload.message || 'Response data field missing summary or history.';
         throw new Error(`API Data Content Error: ${backendMessage}`);
    }

    const { summary, history } = payload.data;
    console.log('API payload structure and status OK. Summary:', summary, 'History count:', history.length);

    const assetNameElement = document.querySelector('.asset-name');
    if (assetNameElement && (summary.symbol || summary.name)) {
        assetNameElement.textContent = summary.name || `${summary.symbol || 'N/A'}/${summary.currency || 'N/A'}`;
    } else if (assetNameElement) {
        assetNameElement.textContent = symbol.toUpperCase();
    }

    const currentPriceEl = document.querySelector('.current-price');
     if (currentPriceEl && summary.price != null) {
         currentPriceEl.textContent = parseFloat(summary.price).toFixed(2);
     } else if (currentPriceEl) {
         currentPriceEl.textContent = '-';
     }

    const changeEl = document.querySelector('.percentage-change');
     if (changeEl && summary.changePercent != null) {
         const changeValue = parseFloat(summary.changePercent);
         if (!isNaN(changeValue)) {
           changeEl.textContent = `${changeValue.toFixed(2)}%`;
           changeEl.classList.remove('positive', 'negative');
           changeEl.classList.toggle('positive', changeValue >= 0);
           changeEl.classList.toggle('negative', changeValue < 0);
         } else {
           changeEl.textContent = '- %';
           changeEl.className = 'percentage-change';
           console.warn('Change percent value is not a number:', summary.changePercent);
         }
     } else if (changeEl) {
          changeEl.textContent = '-';
          changeEl.className = 'percentage-change';
     }

    const ohlcProps = { O: 'open', H: 'high', L: 'low', C: 'close' };
    document.querySelectorAll('.ohlc-details span').forEach(span => {
      const keyMatch = span.textContent.match(/^([OHLC]):/);
      if (!keyMatch || !keyMatch[1]) return;
      const keyDisplay = keyMatch[1];
      const dataKey = ohlcProps[keyDisplay];

      if (dataKey && summary[dataKey] != null) {
        const value = parseFloat(summary[dataKey]);
        if (!isNaN(value)) {
           span.textContent = `${keyDisplay}: ${value.toFixed(2)}`;
        } else {
           span.textContent = `${keyDisplay}: – (Invalid Data)`;
           console.warn(`OHLC value for ${keyDisplay} is not a valid number:`, summary[dataKey]);
        }
      } else {
        span.textContent = `${keyDisplay}: –`;
      }
    });
    console.log('Header updated.');

    if (!priceChartCanvas) {
        console.error('Canvas element not found for chart.');
        return;
    }

    if (history.length === 0) {
        console.warn('No history data (empty array) to plot for interval', interval);
         if (chartContainerParent) {
              priceChartCanvas.style.display = 'none';
              let messageEl = chartContainerParent.querySelector('.chart-message');
              if (!messageEl) {
                  messageEl = document.createElement('p');
                  messageEl.classList.add('chart-message');
                  messageEl.style.textAlign = 'center';
                  messageEl.style.marginTop = '20px';
                   messageEl.style.color = '#64748b';
                  chartContainerParent.insertBefore(messageEl, priceChartCanvas);
              }
              messageEl.textContent = `No chart data available for ${interval} interval.`;
         }
         if (assetChartInstance) {
             console.log('Destroying old chart instance due to no history data.');
             assetChartInstance.destroy();
             assetChartInstance = null;
         }
        return;
    } else if (priceChartCanvas.style.display === 'none' && chartContainerParent) {
         priceChartCanvas.style.display = 'block';
         const messageEl = chartContainerParent.querySelector('.chart-message');
         if (messageEl) {
             messageEl.remove();
         }
    }

    const dataPoints = history.slice().reverse();

    if (dataPoints.length === 0) {
        console.warn('Data points array is empty after processing history.');
         if (chartContainerParent) {
             priceChartCanvas.style.display = 'none';
              let messageEl = chartContainerParent.querySelector('.chart-message');
             if (!messageEl) {
                 messageEl = document.createElement('p');
                  messageEl.classList.add('chart-message');
                 messageEl.style.textAlign = 'center';
                 messageEl.style.marginTop = '20px';
                  messageEl.style.color = '#64748b';
                 chartContainerParent.insertBefore(messageEl, priceChartCanvas);
             }
             messageEl.textContent = 'No sufficient data points for chart after processing.';
         }
        return;
    }

    console.log(`Plotting ${dataPoints.length} data points.`);
    console.log('First data point (oldest):', dataPoints[0]);
    console.log('Last data point (newest):', dataPoints[dataPoints.length - 1]);

    const ctx = priceChartCanvas.getContext('2d');
    if (!ctx) {
        console.error('Could not get 2D context for canvas.');
         if (chartContainerParent) {
              priceChartCanvas.style.display = 'none';
              let messageEl = chartContainerParent.querySelector('.chart-message');
             if (!messageEl) {
                 messageEl = document.createElement('p');
                  messageEl.classList.add('chart-message');
                 messageEl.style.textAlign = 'center';
                 messageEl.style.marginTop = '20px';
                  messageEl.style.color = '#64748b';
                 chartContainerParent.insertBefore(messageEl, priceChartCanvas);
             }
              messageEl.textContent = 'Error initializing chart.';
         }
        return;
    }

    if (assetChartInstance) {
        console.log('Destroying old chart instance.');
        assetChartInstance.destroy();
    }

    const timeScaleOptions = intervalMap[currentInterval] || intervalMap['1min'];

    assetChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dataPoints.map(d => d.datetime),
        datasets: [{
          label: symbol.toUpperCase(),
          data: dataPoints.map(d => parseFloat(d.close)),
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.1)',
          tension: 0.1,
          fill: false,
          pointRadius: 0,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        transitions: { show: { animations: false }, hide: { animations: false }, resize: { animations: false } },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            intersect: false,
            mode: 'index',
            animation: false,
             callbacks: {
                  title: function(tooltipItems) {
                      const item = tooltipItems[0];
                      if (item && dataPoints[item.dataIndex]) {
                           return dataPoints[item.dataIndex].datetime;
                      }
                      return '';
                  },
                  label: function(tooltipItem) {
                      let label = tooltipItem.dataset.label || '';
                      if (label) label += ': ';
                      if (tooltipItem.raw != null) label += parseFloat(tooltipItem.raw).toFixed(2);
                      return label;
                  }
              },
          },
          zoom: {
              zoom: {
                  wheel: { enabled: true },
                  pinch: { enabled: true },
                  mode: 'x',
              },
              pan: {
                  enabled: true,
                  mode: 'x',
              },
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              parser: timeScaleOptions.parser,
              unit: timeScaleOptions.unit,
              displayFormats: timeScaleOptions.displayFormats,
              tooltipFormat: timeScaleOptions.tooltipFormat,
            },
            grid: { display: false },
            ticks: { autoSkip: true, maxRotation: 0, color: '#64748b' },
          },
          y: {
            beginAtZero: false,
            grid: { color: '#e2e8f0' },
            ticks: {
                color: '#64748b',
                callback: function(value) { return parseFloat(value).toFixed(2); }
            },
          }
        }
      }
    });

      console.log('Chart instance created:', assetChartInstance);

     const chartView = document.getElementById('chartView');
     const chartTab = document.querySelector('.tab-btn[data-view="chart"]');
     const anyViewActive = document.querySelector('[id$="View"].active');

     if (chartView && chartTab && !anyViewActive) {
         chartView.classList.add('active');
         chartTab.classList.add('active');
         console.log('Setting Chart view as initially active.');
     } else if (anyViewActive) {
     } else {
          console.warn('Could not find chartView or chartTab elements for initial activation.');
     }

      const bidsList = document.querySelector('.orderbook-list.bids');
      const asksList = document.querySelector('.orderbook-list.asks');

      if (payload.data.orderBook && Array.isArray(payload.data.orderBook.bids) && bidsList) {
          bidsList.innerHTML = payload.data.orderBook.bids.map(bid => {
               const price = parseFloat(bid.price);
               const size = parseFloat(bid.size);
               if (!isNaN(price) && !isNaN(size)) {
                  return `<div class="orderbook-item">${price.toFixed(2)} (${size.toFixed(4)})</div>`;
               }
               return '';
          }).join('');
      } else if (bidsList) { bidsList.innerHTML = '<div>No bid data available.</div>'; }

       if (payload.data.orderBook && Array.isArray(payload.data.orderBook.asks) && asksList) {
          asksList.innerHTML = payload.data.orderBook.asks.map(ask => {
               const price = parseFloat(ask.price);
               const size = parseFloat(ask.size);
               if (!isNaN(price) && !isNaN(size)) {
                  return `<div class="orderbook-item">${price.toFixed(2)} (${size.toFixed(4)})</div>`;
               }
               return '';
          }).join('');
      } else if (asksList) { asksList.innerHTML = '<div>No ask data available.</div>'; }
  } catch (err) {
    const chartBoxElement = document.querySelector('.chart-box');
    if (chartBoxElement) {
        chartBoxElement.innerHTML = `<p style="color: red; text-align: center; padding: 20px;">Failed to load asset data: ${err.message || 'Unknown error'}</p>`;
         chartBoxElement.style.minHeight = '200px';
         chartBoxElement.style.display = 'flex';
         chartBoxElement.style.alignItems = 'center';
         chartBoxElement.style.justifyContent = 'center';
         chartBoxElement.style.flexDirection = 'column';
    }
    console.error('Fatal Error during fetch or processing:', err);
     if (assetChartInstance) {
         assetChartInstance.destroy();
         assetChartInstance = null;
     }
  }
}


document.addEventListener('DOMContentLoaded', async () => {
  const buyBtn  = document.querySelector('.trading-options .buy-btn');
const sellBtn = document.querySelector('.trading-options .sell-btn');
[buyBtn, sellBtn].forEach(btn => {
  if (!btn) return;
  btn.addEventListener('click', () => {
    const url = `/order?symbol=${encodeURIComponent(currentSymbol)}`;
    window.location.href = url;
  });
});

  console.log('DOM fully loaded. Starting asset details fetch.');

  const urlParams = new URLSearchParams(window.location.search);

  const symbolFromUrl = urlParams.get('symbol');
  const typeFromUrl = urlParams.get('type');
  const intervalFromUrl = urlParams.get('interval');

  if (symbolFromUrl) {
    try {
      currentSymbol = decodeURIComponent(symbolFromUrl);
    } catch (e) {
      console.error('Failed to decode symbol from URL:', e);
      currentSymbol = symbolFromUrl;
    }
  }
  if (typeFromUrl) {
    currentType = typeFromUrl;
  }

  const intervalButtons = document.querySelectorAll('.interval-btn');
  const resetZoomButton = document.getElementById('resetZoom');

  if (intervalFromUrl) {
    const urlIntervalButton = document.querySelector(`.interval-btn[data-interval="${intervalFromUrl}"]`);
    if (urlIntervalButton) {
      intervalButtons.forEach(btn => btn.classList.remove('active'));
      urlIntervalButton.classList.add('active');
      currentInterval = intervalFromUrl;
    } else {
      console.warn(`Interval button for ${intervalFromUrl} not found, using default or active button.`);
      const initiallyActiveButton = document.querySelector('.interval-btn.active');
      if (initiallyActiveButton) {
        currentInterval = initiallyActiveButton.dataset.interval || currentInterval;
      }
    }
  } else {
    const initiallyActiveButton = document.querySelector('.interval-btn.active');
    if (initiallyActiveButton) {
      currentInterval = initiallyActiveButton.dataset.interval || currentInterval;
    }
  }


  intervalButtons.forEach(button => {
      button.addEventListener('click', () => {
          const selectedInterval = button.dataset.interval;
          if (selectedInterval && selectedInterval !== currentInterval) {
              intervalButtons.forEach(btn => btn.classList.remove('active'));
              button.classList.add('active');

              currentInterval = selectedInterval;

              console.log(`Interval changed to: ${currentInterval}. Fetching new data.`);
              fetchAndDisplayAssetDetails(currentSymbol, currentType, currentInterval, currentOutputSize);

              if (assetChartInstance) {
                  assetChartInstance.resetZoom();
              }
          } else if (selectedInterval === currentInterval) {
              console.log(`Interval is already ${currentInterval}. No fetch needed.`);
          }
      });
  });

  if (resetZoomButton) {
      resetZoomButton.addEventListener('click', () => {
          console.log('Resetting zoom manually.');
          if (assetChartInstance) {
              assetChartInstance.resetZoom();
          }
      });
  } else {
       console.warn('Reset zoom button not found.');
  }

  console.log('Initial data fetch on DOMContentLoaded.');
  await fetchAndDisplayAssetDetails(currentSymbol, currentType, currentInterval, currentOutputSize);

  const chartBtn = document.querySelector('.tab-btn[data-view="chart"]');
  if (chartBtn) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.querySelectorAll('[id$="View"]').forEach(v => v.classList.remove('active'));
        const targetViewId = `${btn.dataset.view}View`;
        const targetViewElement = document.getElementById(targetViewId);

        if (targetViewElement) {
           targetViewElement.classList.add('active');
        } else {
           console.error(`Tab Error: View element not found for data-view: ${btn.dataset.view}, looked for ID: ${targetViewId}`);
        }

        if (btn.dataset.view === 'chart' && assetChartInstance) {
           requestAnimationFrame(() => {
               console.log('Attempting to resize chart on tab switch.');
               assetChartInstance.resize();
           });
        }
      });
    });
  } else {
       console.warn('Chart tab button not found.');
  }
});
</script>
 <script>
      // Tab Switching Functionality
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.dataset.tabTarget;
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(target).classList.add('active');
        });
      });
      // Expand/Collapse Functionality
      document.querySelectorAll('.expand-control').forEach(control => {
        control.addEventListener('click', (e) => {
          const card = control.closest('.transaction-card');
          const icon = control.querySelector('.expand-icon');
          const details = card.querySelector('.advanced-details');

          details.classList.toggle('active');
          icon.classList.toggle('active');

          // Update control text
          const textSpan = control.querySelector('span');
          textSpan.textContent = details.classList.contains('active') 
            ? 'Hide Details' 
            : 'View Details';

          // Smooth scroll
          if(details.classList.contains('active')) {
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      });
    </script>
    <!-- shows the openeds contract trades -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const contractsBtn   = document.querySelector('.tabs-header .tab-btn[data-tab-target="contracts"]');
  const cardsContainer = document.querySelector('#contracts .transaction-cards');

  // Fetch & render
  async function loadContractPositions() {
    try {
      const res  = await fetch('/api/v1/market/contracts/positions');
      const json = await res.json();
      if (
      !json.success ||
      !Array.isArray(json.data.positions) ||
      json.data.positions.length === 0
    ) {
      cardsContainer.innerHTML = 
        '<p>No open contract trades found.</p>';
      return;
    }
      cardsContainer.innerHTML = '';
      json.data.positions.forEach(pos => {
        const {
          _id, assetPair, direction, openingPrice, currentPrice,
          quantity, leverage, marginUsed, takeProfitPrice,
          stopLossPrice, openingTime, unrealizedPnl
        } = pos;
        const pnlSign     = unrealizedPnl >= 0 ? '+' : '';
        const pnlClass    = unrealizedPnl >= 0 ? 'positive' : 'negative';
        const assetSymbol = assetPair.split(':')[0];
        const openedAt    = new Date(openingTime).toLocaleString();
        const tpDefault   = takeProfitPrice !== null ? takeProfitPrice : 0;
        const slDefault   = stopLossPrice   !== null ? stopLossPrice   : 0;

        cardsContainer.insertAdjacentHTML('beforeend', `
          <div class="transaction-card">
            <div class="card-header">
              <span class="asset-symbol">${assetSymbol}</span>
              <span class="asset-change ${pnlClass}">${pnlSign}${unrealizedPnl.toFixed(2)}</span>
            </div>
            <div class="card-body">
              <div class="basic-info">
                <div class="asset-info">
                  <div class="asset-name">${direction} Position X${quantity}</div>
                  <div class="asset-quantity">Quantity: ${quantity}</div>
                </div>
                <div class="asset-pricing">
                  <div class="price-item"><span>Position Price:</span><span>$${openingPrice}</span></div>
                  <div class="price-item"><span>Leverage:</span><span>${leverage}x</span></div>
                </div>
              </div>
              <div class="advanced-details">
                ${takeProfitPrice !== null ? `<div class="price-item"><span>TP:</span><span>$${takeProfitPrice}</span></div>` : ''}
                ${stopLossPrice    !== null ? `<div class="price-item"><span>SL:</span><span>$${stopLossPrice}</span></div>` : ''}
                <div class="price-item"><span>Margin:</span><span>${marginUsed.toFixed(4)}</span></div>
                <div class="price-item"><span>Latest:</span><span>$${currentPrice}</span></div>
                <div class="price-item"><span>Unrealized PnL:</span><span>$${unrealizedPnl.toFixed(2)}</span></div>
                <div class="price-item"><span>Opened At:</span><span>${openedAt}</span></div>
              </div>
            </div>
            <div class="action-buttons">
              <button 
                class="trxcard-btn1" 
                data-id="${_id}" 
                data-tp="${tpDefault}" 
                data-sl="${slDefault}"
              >Take profit &amp; stop loss</button>
              <button 
                class="trxcard-btn2" 
                data-id="${_id}" 
                data-price="${openingPrice}" 
                data-qty="${quantity}"
              >Close positions</button>
            </div>
            <div class="expand-control"><span>View Details</span></div>
          </div>
        `);
      });
    } catch (err) {
      console.error(err);
      cardsContainer.innerHTML = '<p>Error loading positions.</p>';
    }
  }

  // Delegate clicks
  cardsContainer.addEventListener('click', e => {
    const expand = e.target.closest('.expand-control');
    if (expand) {
      const card = expand.closest('.transaction-card');
      const det = card.querySelector('.advanced-details');
      const lbl = expand.querySelector('span');
      det.classList.toggle('active');
      lbl.textContent = det.classList.contains('active') ? 'Hide Details' : 'View Details';
      if (det.classList.contains('active')) card.scrollIntoView({ behavior: 'smooth' });
      return;
    }

    const closeBtn = e.target.closest('.trxcard-btn2');
    if (closeBtn) {
      const id    = closeBtn.dataset.id;
      const price = closeBtn.dataset.price;
      const qty   = closeBtn.dataset.qty;
      showCloseModal(id, price, qty);
      return;
    }

    const tpSlBtn = e.target.closest('.trxcard-btn1');
    if (tpSlBtn) {
      const id  = tpSlBtn.dataset.id;
      const tp  = tpSlBtn.dataset.tp;
      const sl  = tpSlBtn.dataset.sl;
      showTpSlModal(id, tp, sl);
      return;
    }
  });

  // Close position modal
  function showCloseModal(id, price, qty) {
    const overlay = document.createElement('div');
    overlay.classList.add('modal-overlay');
    const modal = document.createElement('div');
    modal.classList.add('modal-window');
    modal.innerHTML = `
      <h3>Close Position</h3>
      <p>Price: $${parseFloat(price).toFixed(2)}</p>
      <p>Quantity: ${qty}</p>
      <div class="button-group">
        <button id="confirmClose">OK</button>
        <button id="cancelClose">Cancel</button>
      </div>`;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    modal.querySelector('#cancelClose').onclick = () => overlay.remove();
    modal.querySelector('#confirmClose').onclick = async () => {
      try {
        const res = await fetch(`/api/v1/market/contracts/positions/${id}/close`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: '{}'
        });
        const result = await res.json();
        showToast(result.success ? 'Position closed.' : 'Close failed.');
        setTimeout(() => location.reload(), 800);
      } catch {
        showToast('Error closing.');
      } finally {
        overlay.remove();
      }
    };
  }

  // TP/SL modal
  function showTpSlModal(id, tp, sl) {
    const overlay = document.createElement('div');
    overlay.classList.add('modal-overlay');
    const modal = document.createElement('div');
    modal.classList.add('modal-window');
    modal.innerHTML = `
      <h3>Edit TP / SL</h3>
      <div class="modal-field">
        <label>Take Profit:</label>
        <div class="input-group">
          <button class="decr">–</button>
          <input type="number" id="tpInput" value="${tp}" />
          <button class="incr">+</button>
        </div>
      </div>
      <div class="modal-field">
        <label>Stop Loss:</label>
        <div class="input-group">
          <button class="decr">–</button>
          <input type="number" id="slInput" value="${sl}" />
          <button class="incr">+</button>
        </div>
      </div>
      <div class="button-group">
        <button id="confirmTpSl">Submit</button>
        <button id="cancelTpSl">Cancel</button>
      </div>`;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    const tpInput = modal.querySelector('#tpInput');
    const slInput = modal.querySelector('#slInput');
    modal.querySelectorAll('.incr').forEach(b => b.onclick = () => b.previousElementSibling.stepUp());
    modal.querySelectorAll('.decr').forEach(b => b.onclick = () => b.nextElementSibling.stepDown());

    modal.querySelector('#cancelTpSl').onclick = () => overlay.remove();
    modal.querySelector('#confirmTpSl').onclick = async () => {
      const newTp = parseFloat(tpInput.value) || 0;
      const newSl = parseFloat(slInput.value) || 0;
      try {
        const res = await fetch(`/api/v1/market/contracts/positions/${id}`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ takeProfitPrice: newTp, stopLossPrice: newSl })
        });
        const result = await res.json();
        showToast(result.success ? 'TP/SL updated.' : 'Update failed.');
        setTimeout(() => location.reload(), 800);
      } catch {
        showToast('Error updating.');
      } finally {
        overlay.remove();
      }
    };
  }

  // Toast
  function showToast(msg) {
    const toast = document.createElement('div');
    toast.classList.add('toast');
    toast.textContent = msg;
    document.body.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('show'));
    setTimeout(() => {
      toast.classList.remove('show');
      toast.addEventListener('transitionend', () => toast.remove());
    }, 2000);
  }

  // Init
  if (contractsBtn.classList.contains('active')) loadContractPositions();
  contractsBtn.addEventListener('click', loadContractPositions);
});
</script>

<!-- for the option trading system -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const optionsBtn      = document.querySelector('.tabs-header .tab-btn[data-tab-target="options"]');
  const tradesContainer = document.querySelector('#options .transaction-cards');

  // Fetch & render active option trades
  async function loadOptionTrades() {
    try {
      const res  = await fetch('/api/v1/market/options/trades');
      const json = await res.json();
      if (!json.success || !Array.isArray(json.data.trades)) {
        tradesContainer.innerHTML = '<p>No active option trades found.</p>';
        return;
      }

      const activeTrades = json.data.trades.filter(t => t.status === 'Active');
      if (activeTrades.length === 0) {
        tradesContainer.innerHTML = '<p>No active option trades.</p>';
        return;
      }

      tradesContainer.innerHTML = '';
      activeTrades.forEach(trade => {
        const {
          _id,
          assetPair,
          direction,
          investmentAmount,
          openingPrice,
          purchaseTime,
          durationSeconds,
          expiryTime,
          returnPercentage
        } = trade;

        const purchaseAt = new Date(purchaseTime).toLocaleString();
        const expiresAt  = new Date(expiryTime).toLocaleString();

        tradesContainer.insertAdjacentHTML('beforeend', `
          <div class="transaction-card">
            <div class="card-header">
              <span class="asset-symbol">${assetPair.replace('/', ':')}</span>
              <span class="asset-change positive">Active</span>
            </div>
            <div class="card-body">
              <div class="basic-info">
                <div class="asset-info">
                  <div class="asset-name">${direction}</div>
                  <div class="asset-quantity">Invested: $${investmentAmount}</div>
                </div>
                <div class="asset-pricing">
                  <div class="price-item"><span>Opening Price:</span><span>$${openingPrice}</span></div>
                  <div class="price-item"><span>Duration:</span><span>${durationSeconds}s</span></div>
                  <div class="price-item"><span>Return %:</span><span>${returnPercentage}%</span></div>
                </div>
              </div>
              <div class="advanced-details">
                <div class="price-item"><span>Purchased:</span><span>${purchaseAt}</span></div>
                <div class="price-item"><span>Expires:</span><span>${expiresAt}</span></div>
              </div>
            </div>
            <div class="action-buttons">
              <button 
                class="trxcard-btn1" 
                data-id="${_id}" 
                data-investment="${investmentAmount}"
              >Cover positions</button>
            </div>
            <div class="expand-control"><span>View Details</span></div>
          </div>
        `);
      });
    } catch (err) {
      console.error('Error loading option trades:', err);
      tradesContainer.innerHTML = '<p>Error loading option trades.</p>';
    }
  }

  // Delegate clicks: expand/collapse and cover positions
  tradesContainer.addEventListener('click', e => {
    // expand/collapse
    if (e.target.closest('.expand-control')) {
      const ctrl    = e.target.closest('.expand-control');
      const card    = ctrl.closest('.transaction-card');
      const details = card.querySelector('.advanced-details');
      const label   = ctrl.querySelector('span');
      details.classList.toggle('active');
      label.textContent = details.classList.contains('active') ? 'Hide Details' : 'View Details';
      if (details.classList.contains('active')) {
        card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
      return;
    }

    // cover positions -> show add-investment modal
    const coverBtn = e.target.closest('.trxcard-btn1');
    if (coverBtn) {
      const id       = coverBtn.dataset.id;
      const current  = parseFloat(coverBtn.dataset.investment);
      showAddInvestmentModal(id, current);
    }
  });

  // Show modal to add investment
  function showAddInvestmentModal(id, currentAmount) {
    const overlay = document.createElement('div');
    overlay.classList.add('modal-overlay');

    const modal = document.createElement('div');
    modal.classList.add('modal-window');
    modal.innerHTML = `
      <h3>Add Investment</h3>
      <p>Current Invested: $${currentAmount.toFixed(2)}</p>
      <div class="modal-field">
        <label>Additional Amount:</label>
        <div class="input-group">
          <button class="decr">–</button>
          <input type="number" id="addInput" value="0" min="0" />
          <button class="incr">+</button>
        </div>
      </div>
      <div class="button-group">
        <button id="confirmAdd">OK</button>
        <button id="cancelAdd">Cancel</button>
      </div>
    `;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    const input = modal.querySelector('#addInput');
    modal.querySelector('.incr').onclick = () => input.stepUp();
    modal.querySelector('.decr').onclick = () => input.stepDown();
    modal.querySelector('#cancelAdd').onclick = () => overlay.remove();

    modal.querySelector('#confirmAdd').onclick = async () => {
      const additional = parseFloat(input.value) || 0;
      try {
        const res = await fetch(`/api/v1/market/options/trades/${id}/add-investment`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ additionalAmount: additional })
        });
        const result = await res.json();
        showToast(result.success
          ? 'Investment added successfully.'
          : 'Failed to add investment.'
        );
        setTimeout(() => location.reload(), 800);
      } catch (err) {
        console.error(err);
        showToast('Error adding investment.');
      } finally {
        overlay.remove();
      }
    };
  }

  // Simple toast helper
  function showToast(msg) {
    const toast = document.createElement('div');
    toast.classList.add('toast');
    toast.textContent = msg;
    document.body.appendChild(toast);
    requestAnimationFrame(() => toast.classList.add('show'));
    setTimeout(() => {
      toast.classList.remove('show');
      toast.addEventListener('transitionend', () => toast.remove());
    }, 2000);
  }

  // initial load & reload on tab click
  if (optionsBtn.classList.contains('active')) loadOptionTrades();
  optionsBtn.addEventListener('click', loadOptionTrades);
});
</script>




</body>
</html>
